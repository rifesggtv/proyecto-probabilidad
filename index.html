<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬øTal vez s√≠, o tal vez no? (Con Gemini)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #probabilityButton {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .decorative-icon {
            position: absolute;
            pointer-events: none;
            animation: twinkle 3s infinite ease-in-out;
        }
        .decorative-icon.icon1 { top: -10px; left: -15px; font-size: 1.2em; animation-delay: 0s; }
        .decorative-icon.icon2 { top: 0px; right: -20px; font-size: 0.9em; animation-delay: 0.5s; }
        .decorative-icon.icon3 { bottom: -12px; left: 25%; font-size: 0.8em; animation-delay: 1s; }
        .decorative-icon.icon4 { bottom: -5px; right: 15%; font-size: 1em; animation-delay: 1.5s; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(0.8) rotate(-10deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(10deg); }
        }
        .animate-custom-shake {
            animation: custom-shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
        }
        @keyframes custom-shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }
        #interpretationText, #extendedAdviceText, #suggestedLinkText, #darkOmenText, #wordGamePhrase, #easterEggMessage {
            white-space: pre-wrap; 
            word-break: break-word; 
            text-align: center; 
        }
        #resultContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .suggested-link-button {
            display: inline-block; margin-top: 8px; padding: 6px 12px;
            background-color: #f59e0b; color: white; border-radius: 0.375rem; 
            text-decoration: none; font-size: 0.875rem; font-weight: 600; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: background-color 0.2s ease-in-out;
        }
        .suggested-link-button:hover { background-color: #d97706; }
        
        #musicToggleButton {
            position: fixed; bottom: 20px; right: 20px; background-color: #6b7280; 
            color: white; padding: 10px; border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000;
        }
        #musicToggleButton:hover { background-color: #4b5563; }

        #darkOmenButton {
            margin-top: 20px;
            background-color: #1f2937; 
            color: #fca5a5; 
            border: 1px solid #ef4444; 
        }
        #darkOmenButton:hover {
            background-color: #111827; 
            color: #f87171; 
        }
        #wordGameContainer {
            margin-top: 20px;
            padding: 15px;
            background-color: #374151; 
            border: 1px solid #ef4444; 
            border-radius: 0.5rem;
            text-align: center;
            position: relative; 
        }
        #wordGamePhrase {
            color: #fde68a; 
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        #wordGameInput {
            padding: 8px;
            border-radius: 0.25rem;
            border: 1px solid #eab308; 
            background-color: #4b5563; 
            color: white;
            margin-right: 10px;
            width: calc(100% - 130px); 
        }
        #wordGameCheckButton {
            padding: 8px 15px;
            background-color: #eab308; 
            color: #1f2937; 
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: 600;
        }
        #wordGameCheckButton:hover {
            background-color: #f59e0b; 
        }
        #wordGameFeedback {
            margin-top: 10px;
            font-size: 0.9em;
        }
        .audio-suggestion-text {
            font-size: 0.8rem;
            color: #d97706; 
            margin-top: -10px; 
            margin-bottom: 15px;
        }
        #easterEggImage {
            max-width: 80%;
            max-height: 200px; 
            margin: 10px auto;
            border-radius: 0.375rem;
            border: 2px solid #ef4444; 
        }
        #easterEggMessage {
            color: #ef4444; 
            font-weight: bold;
        }
        #wordGameHint {
            position: absolute;
            font-size: 0.7rem;
            color: #9ca3af; 
            background-color: rgba(0,0,0,0.3);
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0.7;
            pointer-events: none; 
        }
        #directEasterEggButton {
            position: fixed;
            top: 15px;
            right: 15px;
            background-color: rgba(0,0,0,0.3);
            color: #fca5a5;
            border: 1px solid #ef4444;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #directEasterEggButton:hover {
            background-color: rgba(0,0,0,0.6);
            color: #f87171;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-300 via-amber-300 to-yellow-300 min-h-screen flex flex-col items-center py-8 px-4 text-gray-800">
   
    <audio id="backgroundMusic" loop>
        <source src="https://audionautix.com/Music/DarkMystery.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
    </audio>
    <audio id="darkOmenMusic" loop>
        <source src="https://audionautix.com/Music/Horror13.mp3" type="audio/mpeg"> 
    </audio>
    <button id="musicToggleButton">üîä</button> 
    <button id="directEasterEggButton" class="hidden">üëÅÔ∏è</button>
    
    <div class="bg-white/90 backdrop-blur-lg p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-orange-700 relative">
                ¬øTal vez s√≠, o tal vez no?
                <span class="decorative-icon icon1">‚ú®</span>
                <span class="decorative-icon icon2">üî∏</span>
                <span class="decorative-icon icon3">‚≠ê</span>
                <span class="decorative-icon icon4">üîÆ</span>
            </h1>
            <p class="audio-suggestion-text">Para una experiencia completa, es mejor si activas el audio en este portal a tu destino.</p>
        </header>

        <main>
            <div class="mb-6">
                <label for="questionInput" class="sr-only">Ingresa tu pregunta:</label>
                <textarea id="questionInput" class="w-full p-3 border border-orange-400 rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none text-lg placeholder-gray-500" rows="3" placeholder="Ej: ¬øDebo adoptar otro gato?"></textarea>
            </div>

            <button id="probabilityButton" class="bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white font-bold text-5xl w-32 h-32 sm:w-36 sm:h-36 rounded-full shadow-lg transition-transform duration-100 ease-in-out active:scale-90 flex items-center justify-center mb-6 focus:outline-none focus:ring-4 focus:ring-orange-300 mx-auto">
                %
            </button>

            <div id="resultContainer" class="p-4 bg-orange-50 rounded-lg shadow-inner w-full"> 
                <div id="dynamicIconSlot" class="absolute top-2 right-2 h-8 w-8 sm:h-10 sm:w-10 opacity-80">
                    <svg id="celebrationIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-yellow-500 animate-pulse"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624L16.5 21.75l-.398-1.126a3.375 3.375 0 00-2.455-2.456L12.75 18l1.126-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.126a3.375 3.375 0 002.456 2.456L20.25 18l-1.126.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
                    <svg id="doubtIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-blue-500 animate-pulse"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>
                    <svg id="screamerIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                </div>

                <p id="calculatingText" class="text-orange-600 text-xl font-semibold hidden animate-pulse">Sintonizando con el cosmos...</p>
                <div id="finalResult" class="hidden w-full"> 
                    <p id="askedQuestion" class="text-gray-700 mb-2 text-md sm:text-lg italic"></p>
                    <p id="probabilityText" class="text-5xl font-bold text-orange-700"></p>
                    <p id="interpretationText" class="text-sm text-amber-800 mt-2 font-medium"></p>
                </div>
                <p id="initialMessage" class="text-gray-500 text-md">Ingresa una pregunta y mant√©n presionado el bot√≥n.</p>

                <button id="extendedAdviceButton" class="hidden mt-4 bg-amber-500 hover:bg-amber-600 active:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform duration-100 ease-in-out active:scale-95 text-sm">
                    ‚ú® Dame m√°s sabidur√≠a
                </button>
                <div id="extendedAdviceContainer" class="hidden mt-3 pt-3 border-t border-orange-200 w-full">
                    <p id="loadingExtendedAdvice" class="text-amber-700 text-sm font-semibold hidden animate-pulse">El Or√°culo busca en los confines del conocimiento...</p>
                    <p id="extendedAdviceText" class="text-sm text-orange-700"></p>
                    <div id="suggestedLinkContainer" class="hidden mt-2">
                        <p id="suggestedLinkText" class="text-xs text-gray-600"></p>
                    </div>
                </div>
                 <div id="darkOmenContainer" class="hidden mt-4 pt-4 border-t-2 border-red-700 w-full">
                    <p id="loadingDarkOmen" class="text-red-700 text-sm font-semibold hidden animate-pulse">El Abismo susurra...</p>
                    <p id="darkOmenText" class="text-sm text-red-800 font-mono"></p>
                    <div id="easterEggDisplay" class="hidden mt-2">
                        <img id="easterEggImage" src="" alt="Una visi√≥n perturbadora" onerror="this.alt='El Or√°culo te observa... pero la imagen no pudo cargarse.'; this.style.display='none'; document.getElementById('easterEggMessage').textContent = this.alt;">
                        <p id="easterEggMessage" class="mt-2 text-red-600 font-semibold"></p>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="mt-8">
            <p id="instructionText" class="text-sm text-gray-600 font-medium">prep√°rate para saber si har√°s eso o no</p>
        </footer>

        <button id="darkOmenButton" class="mt-6 w-full py-3 px-4 rounded-lg shadow-lg font-semibold text-sm transition-colors duration-150 ease-in-out">
            No le des click
        </button>

        <div id="wordGameContainer" class="hidden mt-4">
            <p class="text-red-300 text-sm mb-2">Has elegido asomarte al abismo. Completa el presagio para ver lo que te espera...</p>
            <div id="wordGameHint" class="hidden"></div>
            <p id="wordGamePhrase" class="text-lg"></p>
            <input type="text" id="wordGameInput" class="mt-2" placeholder="Escribe aqu√≠ la palabra...">
            <button id="wordGameCheckButton" class="mt-2">Revelar Destino</button>
            <p id="wordGameFeedback" class="mt-2 text-sm"></p>
        </div>
    </div>

    <script>
        const questionInput = document.getElementById('questionInput');
        const probabilityButton = document.getElementById('probabilityButton');
        const calculatingText = document.getElementById('calculatingText'); 
        const finalResult = document.getElementById('finalResult');
        const askedQuestion = document.getElementById('askedQuestion');
        const probabilityText = document.getElementById('probabilityText');
        const interpretationText = document.getElementById('interpretationText'); 
        const instructionText = document.getElementById('instructionText');
        const initialMessage = document.getElementById('initialMessage');

        const celebrationIcon = document.getElementById('celebrationIcon');
        const doubtIcon = document.getElementById('doubtIcon');
        const screamerIcon = document.getElementById('screamerIcon');

        const extendedAdviceButton = document.getElementById('extendedAdviceButton');
        const extendedAdviceContainer = document.getElementById('extendedAdviceContainer');
        const loadingExtendedAdvice = document.getElementById('loadingExtendedAdvice');
        const extendedAdviceText = document.getElementById('extendedAdviceText');
        
        const suggestedLinkContainer = document.getElementById('suggestedLinkContainer');
        const suggestedLinkText = document.getElementById('suggestedLinkText');

        const darkOmenButton = document.getElementById('darkOmenButton');
        const wordGameContainer = document.getElementById('wordGameContainer');
        const wordGamePhrase = document.getElementById('wordGamePhrase');
        const wordGameInput = document.getElementById('wordGameInput');
        const wordGameCheckButton = document.getElementById('wordGameCheckButton');
        const wordGameFeedback = document.getElementById('wordGameFeedback');
        const wordGameHint = document.getElementById('wordGameHint'); 
        const darkOmenContainer = document.getElementById('darkOmenContainer');
        const loadingDarkOmen = document.getElementById('loadingDarkOmen');
        const darkOmenText = document.getElementById('darkOmenText');
        const easterEggDisplay = document.getElementById('easterEggDisplay');
        const easterEggImage = document.getElementById('easterEggImage');
        const easterEggMessage = document.getElementById('easterEggMessage');
        const directEasterEggButton = document.getElementById('directEasterEggButton');
        
        const backgroundMusic = document.getElementById('backgroundMusic');
        const darkOmenMusicElement = document.getElementById('darkOmenMusic'); 
        const musicToggleButton = document.getElementById('musicToggleButton');
        let isMusicPlaying = false; 
        let isDarkOmenMusicPlaying = false; 
        
        let isHolding = false;
        let audioStarted = false; 
        let currentQuestion = "";
        let currentProbability = 0;
        let currentInterpretation = ""; 
        let currentOraclePersonality = "dark"; 
        let currentWordGame = null;
        let lastWordGameIndex = -1; 

        const GEMINI_API_KEY = "AIzaSyDRCB8TMeVcvHcI7pA6D_xExLWZewgARtk"; 

        const easterEggImageUrls = [
            "https://i.pinimg.com/236x/cd/d3/a2/cdd3a252a07d32abbe04c8c5bfd9d0bf.jpg",
            // "https://www.google.com/url?sa=i&url=...", // Omitida por ser redirect
            "https://i.pinimg.com/474x/86/8a/63/868a635c86534add0279d27cb0beeab3.jpg",
            "https://i.blogs.es/6af668/horror-japones/650_1200.jpg",
            "https://i.pinimg.com/1200x/55/8d/93/558d93cce18462d8a355052e2450fb76.jpg",
            "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT8ClYI6ibhNJqpN6IGm6BUu9dcQuEtkNavmA&s",
            "https://i.pinimg.com/564x/58/94/2c/58942c6652a619c6329daef755356c30.jpg",
            "https://open-images.acast.com/shows/60e3e6eaac95f6001308c1a8/1730909608751-7cf7afd4-338e-4541-9a6b-84fc58cf6133.jpeg?height=750"
        ];

        const wordGamePhrases = [
            { display: "Los m_ _ _ _ _ no siempre terminan al despertar.", answer: "miedos", fullPhrase: "Los miedos no siempre terminan al despertar." },
            { display: "Las s_ _ _ _ _ _ pueden hablar en la oscuridad.", answer: "sombras", fullPhrase: "Las sombras pueden hablar en la oscuridad." },
            { display: "El t_ _ _ _ _ no siempre avisa antes de llegar.", answer: "terror", fullPhrase: "El terror no siempre avisa antes de llegar." },
            { display: "Un r_ _ _ _ en la noche rara vez es inocente.", answer: "ruido", fullPhrase: "Un ruido en la noche rara vez es inocente." },
            { display: "Las c_ _ _ _ rotas a veces susurran.", answer: "cosas", fullPhrase: "Las cosas rotas a veces susurran." },
            { display: "Mira dos veces al e_ _ _ _ _ _, por si no eres t√∫.", answer: "espejo", fullPhrase: "Mira dos veces al espejo, por si no eres t√∫." },
            { display: "El v_ _ _ _ puede traerte recuerdos que no viviste.", answer: "vacio", fullPhrase: "El vac√≠o puede traerte recuerdos que no viviste." },
            { display: "Hay p_ _ _ _ _ _ que no se deben abrir.", answer: "puertas", fullPhrase: "Hay puertas que no se deben abrir." },
            { display: "Las m_ _ _ _ _ _ tambi√©n tienen memoria.", answer: "muertas", fullPhrase: "Las muertas tambi√©n tienen memoria." },
            { display: "No todo l_ _ _ _ _ regresa es bienvenido.", answer: "loque", fullPhrase: "No todo lo que regresa es bienvenido." },
            { display: "Los s_ _ _ _ _ _ _ pueden seguirte en silencio.", answer: "suspiros", fullPhrase: "Los suspiros pueden seguirte en silencio." },
            { display: "El r_ _ _ _ _ _ _ puede ser m√°s real que la vida.", answer: "recuerdo", fullPhrase: "El recuerdo puede ser m√°s real que la vida." },
            { display: "Los p_ _ _ _ _ _ _ _ caminan incluso sin cuerpo.", answer: "pensares", fullPhrase: "Los pensares caminan incluso sin cuerpo." },
            { display: "No mires d_ _ _ _ _ de la puerta cerrada.", answer: "detras", fullPhrase: "No mires detr√°s de la puerta cerrada." },
            { display: "La a_ _ _ _ _ _ _ pesa m√°s que el cuerpo.", answer: "ausencia", fullPhrase: "La ausencia pesa m√°s que el cuerpo." },
            { display: "A veces la v_ _ se siente m√°s muerta que el silencio.", answer: "voz", fullPhrase: "A veces la voz se siente m√°s muerta que el silencio." },
            { display: "No conf√≠es en las p_ _ _ _ _ _ _ que no entiendes.", answer: "promesas", fullPhrase: "No conf√≠es en las promesas que no entiendes." },
            { display: "El c_ _ _ _ puede nacer del m√°s dulce rostro.", answer: "cruel", fullPhrase: "El cruel puede nacer del m√°s dulce rostro." },
            { display: "Las c_ _ _ _ _ _ _ _ te observan cuando no miras.", answer: "criaturas", fullPhrase: "Las criaturas te observan cuando no miras." },
            { display: "La p_ _ _ puede fingir ser consuelo.", answer: "pena", fullPhrase: "La pena puede fingir ser consuelo." },
            { display: "Detr√°s del s_ _ _ _ _ _ puede haber un grito.", answer: "susurro", fullPhrase: "Detr√°s del susurro puede haber un grito." },
            { display: "La n_ _ _ _ no siempre trae descanso.", answer: "noche", fullPhrase: "La noche no siempre trae descanso." },
            { display: "Hay o_ _ _ _ _ _ _ _ que no deber√≠an ser escuchadas.", answer: "oraciones", fullPhrase: "Hay oraciones que no deber√≠an ser escuchadas." },
            { display: "Una m_ _ _ _ _ _ puede quedar atrapada en los muros.", answer: "memoria", fullPhrase: "Una memoria puede quedar atrapada en los muros." },
            { display: "Los r_ _ _ _ _ _ _ no siempre terminan al despertar.", answer: "rituales", fullPhrase: "Los rituales no siempre terminan al despertar." },
            { display: "La c_ _ _ a veces respira por las noches.", answer: "casa", fullPhrase: "La casa a veces respira por las noches." },
            { display: "A veces el m_ _ _ _ _ _ _ se disfraza de rutina.", answer: "monstruo", fullPhrase: "A veces el monstruo se disfraza de rutina." },
            { display: "Las p_ _ _ _ _ _ _ _ _ nunca abandonan del todo.", answer: "pesadillas", fullPhrase: "Las pesadillas nunca abandonan del todo." },
            { display: "Nadie est√° s_ _ _ _ _ cuando sue√±a demasiado profundo.", answer: "seguro", fullPhrase: "Nadie est√° seguro cuando sue√±a demasiado profundo." },
            { display: "Hay a_ _ _ _ que prefieren la oscuridad.", answer: "almas", fullPhrase: "Hay almas que prefieren la oscuridad." },
            { display: "Un d_ _ _ _ puede quedarse atrapado en el tiempo.", answer: "deseo", fullPhrase: "Un deseo puede quedarse atrapado en el tiempo." },
            { display: "Los e_ _ _ _ _ _ _ _ no entienden de descanso.", answer: "espiritus", fullPhrase: "Los esp√≠ritus no entienden de descanso." },
            { display: "Cuidado con las m_ _ _ _ _ _ que susurran tu nombre.", answer: "muertes", fullPhrase: "Cuidado con las muertes que susurran tu nombre." },
            { display: "El s_ _ _ _ _ _ _ puede arrastrarte sin tocarte.", answer: "silencio", fullPhrase: "El silencio puede arrastrarte sin tocarte." },
            { display: "Las e_ _ _ _ _ _ _ _ se alimentan del olvido.", answer: "entidades", fullPhrase: "Las entidades se alimentan del olvido." },
            { display: "Detr√°s de cada e_ _ _ _ _ _ hay una historia que suplica ser olvidada.", answer: "esquina", fullPhrase: "Detr√°s de cada esquina hay una historia que suplica ser olvidada." },
            { display: "No siempre est√°s s_ _ _ cuando est√°s solo.", answer: "solo", fullPhrase: "No siempre est√°s solo cuando est√°s solo." },
            { display: "Las h_ _ _ _ _ _ tambi√©n tienen cicatrices.", answer: "huellas", fullPhrase: "Las huellas tambi√©n tienen cicatrices." },
            { display: "Los r_ _ _ _ _ _ _ _ no se cierran del todo.", answer: "recuerdos", fullPhrase: "Los recuerdos no se cierran del todo." },
            { display: "Las c_ _ _ _ _ _ a veces lloran en voz baja.", answer: "cuerdas", fullPhrase: "Las cuerdas a veces lloran en voz baja." },
            { display: "El m_ _ _ _ _ _ _ te encuentra cuando dejas de buscarlo.", answer: "misterio", fullPhrase: "El misterio te encuentra cuando dejas de buscarlo." },
            { display: "Los o_ _ _ _ _ no siempre est√°n vac√≠os.", answer: "ojales", fullPhrase: "Los ojales no siempre est√°n vac√≠os." },
            { display: "La c_ _ _ _ _ puede hablar si escuchas con miedo.", answer: "ceniza", fullPhrase: "La ceniza puede hablar si escuchas con miedo." },
            { display: "Lo que oyes al d_ _ _ _ _ no siempre es eco.", answer: "dormir", fullPhrase: "Lo que oyes al dormir no siempre es eco." },
            { display: "Las a_ _ _ _ _ _ _ _ _ _ _ pueden ser trampas disfrazadas.", answer: "advertencias", fullPhrase: "Las advertencias pueden ser trampas disfrazadas." },
            { display: "Los e_ _ _ _ _ _ _ _ _ _ m√°s grandes no hacen ruido.", answer: "escalofrios", fullPhrase: "Los escalofr√≠os m√°s grandes no hacen ruido." },
            { display: "Hay j_ _ _ _ _ que terminan en lo eterno.", answer: "juegos", fullPhrase: "Hay juegos que terminan en lo eterno." },
            { display: "Cuidado con los n_ _ _ _ _ _ que regresan.", answer: "nombres", fullPhrase: "Cuidado con los nombres que regresan." },
            { display: "El p_ _ _ _ _ no siempre pertenece a esta casa.", answer: "pasado", fullPhrase: "El pasado no siempre pertenece a esta casa." },
            { display: "Si escuchas a la n_ _ _ _ respirar, no respondas.", answer: "noche", fullPhrase: "Si escuchas a la noche respirar, no respondas." },
            { display: "Las m_ _ _ _ _ _ _ esperan en los bordes del sue√±o.", answer: "mentiras", fullPhrase: "Las mentiras esperan en los bordes del sue√±o." },
            { display: "No todos los m_ _ _ _ _ _ quieren descansar.", answer: "muertos", fullPhrase: "No todos los muertos quieren descansar." },
            { display: "El o_ _ _ _ _ puede ser la mejor trampa.", answer: "olvido", fullPhrase: "El olvido puede ser la mejor trampa." },
            { display: "A veces la l_ _ es peor que la sombra.", answer: "luz", fullPhrase: "A veces la luz es peor que la sombra." }
        ];

        const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.3 }, volume: -6 }).toDestination();
        // noiseSynth y FMSynth se mantienen igual
        const noiseSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }, volume: -10 }).toDestination();
        const FMSynth = new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.01, sustain: 1, release: 0.5 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.5, decay: 0, sustain: 1, release: 0.5 }, volume: -10 }).toDestination();
        let screamSynth; 

        async function callGeminiAPI(prompt) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error de Gemini API:', response.status, errorData);
                    let apiErrorMessage = 'No se pudo obtener respuesta.';
                     if (response.status === 503) {
                        apiErrorMessage = "El Or√°culo est√° meditando profundamente (servidor sobrecargado). Intenta en unos momentos.";
                    } else if (errorData && errorData.error && errorData.error.message) {
                        apiErrorMessage = errorData.error.message;
                    }
                    return { error: true, message: `El Or√°culo dice: "Interferencias c√≥smicas... (${apiErrorMessage})."` };
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 &&
                    data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    return { error: false, message: data.candidates[0].content.parts[0].text.trim() };
                } else {
                    console.warn('Respuesta inesperada de Gemini API:', data);
                    let fallbackMessage = `El Or√°culo murmura algo ininteligible...`;
                    if (data.error && data.error.message) {
                        fallbackMessage = `El Or√°culo est√° confundido: ${data.error.message}.`;
                    }
                    return { error: true, message: fallbackMessage };
                }
            } catch (error) {
                console.error('Error al contactar Gemini API:', error);
                return { error: true, message: `El Or√°culo parece estar de vacaciones en otra dimensi√≥n.` };
            }
        }

        async function getGeminiInterpretation(question, probability, personality) {
            let prompt;
            if (personality === 'angelic') {
                prompt = `Eres un or√°culo de luz, un ser angelical lleno de esperanza y sabidur√≠a gentil.
La pregunta espec√≠fica del consultante es: "${question}".
La probabilidad calculada (de 0% a 100%) de que esto suceda es: ${probability}%.
Tu tarea es dar una interpretaci√≥n breve (1-2 frases M√ÅXIMO), reconfortante y en espa√±ol que est√© DIRECTAMENTE RELACIONADA con el tema de la pregunta "${question}".
El tono debe ser MUY espec√≠fico seg√∫n la probabilidad, pero SIEMPRE desde una perspectiva de luz y esperanza:
- 0-20%: Ofrece consuelo y una perspectiva de aprendizaje o crecimiento, incluso si el resultado parece improbable. Ej: "Sobre '${question}'... aunque las estrellas muestren un camino arduo con este ${probability}%, recuerda que cada desaf√≠o es una joya disfrazada. La fe mueve monta√±as."
- 21-40%: Inspira esperanza y fortaleza, sugiriendo que hay poder en la perseverancia. Ej: "Para '${question}', este ${probability}% es una invitaci√≥n a cultivar tu luz interior. A veces, los milagros florecen donde menos se espera."
- 41-60%: Positivo y sereno, hablando de equilibrio y confianza. Ej: "Este ${probability}% para '${question}' vibra con armon√≠a. Mant√©n tu coraz√≥n abierto y el camino se revelar√°."
- 61-90%: Alegre y afirmativo, celebrando la buena fortuna. Ej: "¬°Qu√© bella energ√≠a trae este ${probability}% para '${question}'! El universo conspira a tu favor."
- 91-100%: Respuesta po√©tica, et√©rea y profundamente alegre, celebrando la manifestaci√≥n divina. Ej: "¬°Un ${probability}% celestial para '${question}'! Los √°ngeles cantan y tejen un manto de luz dorada para tu triunfo inminente."
No menciones que eres una IA. S√© la personificaci√≥n de una entidad de luz. S√© original y evita clich√©s.`;
            } else { 
                prompt = `Eres un or√°culo muy particular: directo, a veces oscuro, y con un toque de humor negro y terror, a veces terror psicologico, tambien eres muy comico, ironico, y satirico, si notas alguna falta de ortografia en la pregunta, la recalcas con una broma y luego sigues siendo el oraculo.
La pregunta espec√≠fica del consultante es: "${question}".
La probabilidad calculada (de 0% a 100%) de que esto suceda es: ${probability}%.
Tu tarea es dar una interpretaci√≥n breve (1-2 frases M√ÅXIMO), contundente y en espa√±ol que est√© DIRECTAMENTE RELACIONADA con el tema de la pregunta "${question}".
El tono debe ser MUY espec√≠fico seg√∫n la probabilidad:
- 0-10% (Extremadamente Baja): Respuesta con terror psicol√≥gico sutil, desesperanzadora y desgarradora. Ej: "Sobre '${question}'... las sombras susurran que ese camino solo lleva a un eco vac√≠o. No mires atr√°s."
- 11-25% (Muy Baja): Tono de advertencia seria, ominosa, casi una amenaza velada. Ej: "Preguntas por '${question}'. Hay puertas que es mejor no abrir. El ${probability}% de luz es devorado por la oscuridad restante."
- 26-40% (Baja): Seria, directa, un poco desalentadora, sin rodeos. Ej: "Respecto a '${question}', el ${probability}% sugiere que las estrellas no est√°n alineadas. Considera otros vientos."
- 41-60% (Media): Ambiguo pero contundente, dejando una sensaci√≥n de incertidumbre inquietante. Ej: "El ${probability}% para '${question}' flota en el √©ter. Ni s√≠, ni no, sino un quiz√°s que pesa."
- 61-75% (Alta): Seria pero con un matiz de posibilidad real, pr√°ctica. Ej: "Hay un ${probability}% de que '${question}' se materialice. El esfuerzo ser√° tu catalizador."
- 76-90% (Muy Alta): Contundente y positiva, casi una afirmaci√≥n, pero sin excesiva efusividad. Ej: "Con un ${probability}%, '${question}' parece un destino casi sellado. Procede con confianza."
- 91-100% (Casi Certeza/Certeza): Respuesta po√©tica, elegante y muy alegre, celebrando la alta probabilidad. Ej: "¬°Un ${probability}% glorioso para '${question}'! Los cosmos danzan a tu favor, tejiendo un manto de estrellas para tu √©xito."
No menciones que eres una IA. Evita ser filos√≥fico o demasiado abstracto, se muy real, casi humano, y analiza las pregnutas para hacer que los que pregunten sientas inquietud o asombro, excepto en el rango 91-100%. S√© original.`;
            }

            interpretationText.textContent = 'El Or√°culo Gemini consulta los astros distantes...';
            finalResult.classList.remove('hidden'); 
            probabilityText.textContent = `${probability}%`; 
            askedQuestion.textContent = `Preguntaste: "${question}"`;
            
            const result = await callGeminiAPI(prompt);
            currentInterpretation = result.message; 
            return result; 
        }

        async function getExtendedGeminiAdvice(originalQuestion, prob, initialInterpretationFromOracle, personality) {
            if (initialInterpretationFromOracle.startsWith("El Or√°culo dice: \"Interferencias c√≥smicas... (API key not valid")) {
                 return {error: true, message: "El Or√°culo no puede dar m√°s consejos si la conexi√≥n inicial fall√≥ por la clave."};
            }
            
            let personalityInstructions;
            if (personality === 'angelic') {
                personalityInstructions = "Eres el mismo or√°culo de luz y esperanza. Mant√©n un tono gentil y reconfortante.";
            } else {
                personalityInstructions = "Eres el mismo or√°culo (directo, a veces oscuro, con humor negro, pero po√©tico en la alegr√≠a extrema). Mant√©n el tono de la interpretaci√≥n inicial.";
            }

            const prompt = `${personalityInstructions}
Pregunta original: "${originalQuestion}"
Probabilidad calculada: ${prob}%
Tu interpretaci√≥n inicial fue: "${initialInterpretationFromOracle}" 

Ahora, el consultante quiere m√°s sabidur√≠a. Bas√°ndote en todo lo anterior, ofrece UNO de los siguientes, manteniendo el tono apropiado:
1. Un breve consejo adicional o una reflexi√≥n m√°s profunda (1-2 frases).
2. Un peque√±o "ritual" o acci√≥n simb√≥lica (seria, misteriosa, o alegre/inspiradora seg√∫n el caso) que el consultante podr√≠a hacer.
3. Un proverbio o cita (puede ser inventada) que resuene con el momento.

Adicionalmente, si se te ocurre, puedes sugerir sutilmente algo extra y relevante:
- Una canci√≥n (ej: "Para este momento, quiz√°s una canci√≥n como '[Nombre Canci√≥n]' de '[Artista]'...").
- Un tipo de video (ej: "Un video sobre '[tema del video]' podr√≠a ser inspirador.").
- Una curiosidad o dato.
- Una peque√±a historia o an√©cdota.
- La descripci√≥n de un art√≠culo o imagen.
Esta sugerencia extra es opcional y debe ser breve. No crees enlaces HTML ni muestres im√°genes.
No repitas la probabilidad. S√© conciso y sorprendente. Responde solo con el consejo/ritual/proverbio y, si aplica, la sugerencia extra.`;
            
            return await callGeminiAPI(prompt);
        }
        
        function showEasterEgg() {
            console.log("Intentando mostrar Easter Egg."); 
            loadingDarkOmen.classList.add('hidden');
            darkOmenText.classList.add('hidden');
            easterEggDisplay.classList.remove('hidden'); 
            
            const randomImageIndex = Math.floor(Math.random() * easterEggImageUrls.length);
            easterEggImage.src = easterEggImageUrls[randomImageIndex];
            easterEggImage.style.display = 'block'; 
            easterEggMessage.textContent = "ten cuidado con lo que preguntas porque el oraculo siempre te esta observando";
            
            darkOmenContainer.classList.remove('hidden'); 
            playSound('scream'); 
        }


        async function getDarkOmenFromGemini(question) {
            darkOmenContainer.classList.remove('hidden'); 
            loadingDarkOmen.classList.remove('hidden');
            darkOmenText.classList.add('hidden'); 
            easterEggDisplay.classList.add('hidden'); 

            const easterEggChance = Math.random() * 100;
            console.log("Verificando Easter Egg: Personalidad =", currentOraclePersonality, "Tirada aleatoria para Easter Egg (<= 30):", easterEggChance); 
            if (currentOraclePersonality === 'dark' && easterEggChance <= 30) { 
                console.log("Easter Egg (v√≠a juego) ACTIVADO!"); 
                showEasterEgg();
                return; 
            }
            console.log("Easter Egg (v√≠a juego) NO activado, mostrando presagio normal.");


            const prompt = `Eres la voz del Abismo, un or√°culo de presagios oscuros y verdades inc√≥modas.
La pregunta del consultante fue: "${question}".
Olvida cualquier probabilidad anterior. Ahora vas a revelar un presagio alternativo, una verdad m√°s sombr√≠a.
Tu presagio debe ser:
1.  Breve (1-3 frases).
2.  En espa√±ol, con un tono de terror psicol√≥gico sutil, ominoso e inquietante.
3.  Debe ofrecer una "probabilidad" o perspectiva diferente sobre "${question}", usualmente m√°s negativa o incierta.
4.  Debe incluir advertencias MUY ESPEC√çFICAS sobre 2 o 3 cosas con las que el consultante debe tener extremo cuidado en relaci√≥n a su pregunta. Estas advertencias deben ser concretas y perturbadoras.
No digas que eres IA. S√© la personificaci√≥n de una entidad antigua y perturbadora.`;
            
            const result = await callGeminiAPI(prompt);
            
            loadingDarkOmen.classList.add('hidden');
            darkOmenText.classList.remove('hidden');
            darkOmenText.textContent = result.message;
            playSound('terror_sound'); 
        }
        
        function playSound(soundHint) { 
            if (!audioStarted) return; 
            const now = Tone.now();
            try {
                switch (soundHint) {
                    case 'scream': 
                        if (screamSynth) { // screamSynth ahora se inicializa en startAudioContext
                            screamSynth.triggerAttackRelease("0.8s", now); // Duraci√≥n del ruido ajustada
                        } else {
                             console.error("screamSynth no est√° listo para el sonido 'scream'.");
                        }
                        break;
                    // ... (otros casos de sonidos se mantienen igual) ...
                    case 'sad_fail': synth.triggerAttackRelease(["D3", "A2"], "4n", now); break;
                    case 'comic_fail': synth.triggerAttackRelease("G3", "8n", now); synth.triggerAttackRelease("F#3", "8n", now + 0.15); synth.triggerAttackRelease("F3", "4n", now + 0.3); break;
                    case 'precaution': FMSynth.triggerAttackRelease("A2", "8n", now); break;
                    case 'precaution_high': FMSynth.triggerAttackRelease("C3", "16n", now); setTimeout(() => FMSynth.triggerAttackRelease("C3", "16n", now + 0.2), 100); break;
                    case 'terror_sound': noiseSynth.volume.value = -5; noiseSynth.triggerAttackRelease("16n", now); setTimeout(() => noiseSynth.volume.value = -15, 200); break; 
                    case 'mystery': case 'mystery_dark': synth.triggerAttackRelease(["A3", "Eb4", "G#4"], "4n", now, 0.5); break;
                    case 'neutral_ping': synth.triggerAttackRelease("C5", "16n", now, 0.6); break;
                    case 'comic_neutral': synth.triggerAttackRelease("C4", "16n", now); synth.triggerAttackRelease("E4", "16n", now + 0.1); synth.triggerAttackRelease("G3", "8n", now + 0.2); break;
                    case 'neutral_calm': synth.triggerAttackRelease(["C4","E4","G4","C5"], "1n", now, 0.2); break;
                    case 'positive_gentle': case 'positive_calm': case 'mystery_positive': synth.triggerAttackRelease(["G4", "B4", "D5"], "2n", now, 0.7); break;
                    case 'comic_positive': synth.triggerAttackRelease("G4", "8n", now); synth.triggerAttackRelease("C5", "8n", now + 0.15); synth.triggerAttackRelease("E5", "4n", now + 0.3); break;
                    case 'positive_medium': case 'positive_bright': case 'positive_strong': synth.triggerAttackRelease(["C4", "G4", "C5", "E5"], "2n", now, 0.8); break;
                    case 'comic_very_positive': synth.triggerAttackRelease("C5", "16n", now); synth.triggerAttackRelease("E5", "16n", now + 0.05); synth.triggerAttackRelease("G5", "8n", now + 0.1); synth.triggerAttackRelease("C6", "4n", now + 0.2); break;
                    case 'positive_fanfare_short': case 'super_positive': synth.triggerAttackRelease(["G4", "C5", "E5", "G5"], "1n", now, 0.9); break;
                    case 'comic_super_positive': const t = now; ["C4","E4","G4","C5","E5","G5","C6"].forEach((note, i) => { synth.triggerAttackRelease(note, "32n", t + i * 0.05, 0.9); }); break;
                    case 'positive_fanfare_long': case 'ultimate_positive': case 'super_positive_fanfare': case 'ultimate_fanfare': case 'comic_ultimate_win': const t2 = now; ["C4","E4","G4","C5"].forEach((note, i) => synth.triggerAttackRelease(note, "8n", t2 + i*0.1)); setTimeout(()=> {["E5","G5","C6"].forEach((note, i) => synth.triggerAttackRelease(note, "8n", t2 + 0.4 + i*0.1));}, 400); break;
                    default: synth.triggerAttackRelease("C4", "8n", now);
                }
            } catch (e) { console.error("Error al reproducir sonido:", e); }
        }
        
        let calculatingSoundLoop = null;
        function playCalculatingSound() { 
            if (!audioStarted) return;
            if (calculatingSoundLoop) calculatingSoundLoop.stop().dispose();
            calculatingSoundLoop = new Tone.Loop(time => { FMSynth.triggerAttackRelease("C2", "32n", time, 0.2); }, "8n").start(0);
            Tone.Transport.start();
        }
        function stopCalculatingSound() { 
            if (calculatingSoundLoop) { calculatingSoundLoop.stop().dispose(); calculatingSoundLoop = null; }
        }

        async function startAudioContext() {
            if (!audioStarted) {
                try { 
                    await Tone.start();
                    audioStarted = true;
                    
                    // Scream Synth simplificado
                    screamSynth = new Tone.NoiseSynth({
                        noise: { type: "white" }, // Ruido blanco para un sonido m√°s agudo/penetrante
                        envelope: {
                            attack: 0.005, // Ataque muy r√°pido
                            decay: 0.4,    // Decaimiento corto
                            sustain: 0.01, // Muy poco sostenido
                            release: 0.3   // Liberaci√≥n corta
                        },
                        volume: -3 // Ajustar volumen seg√∫n sea necesario
                    }).toDestination();

                    console.log("Contexto de audio Tone.js iniciado y screamSynth creado.");
                } catch (e) {
                    console.error("Error al iniciar el contexto de audio de Tone.js:", e);
                }
            }
        }

        function hideAllDynamicIcons() {
            celebrationIcon.classList.add('hidden');
            doubtIcon.classList.add('hidden');
            screamerIcon.classList.add('hidden');
            screamerIcon.classList.remove('animate-custom-shake');
        }

        function handleInteractionStart() {
            startAudioContext(); 
            const question = questionInput.value.trim();
            if (!question) { 
                finalResult.classList.add('hidden'); calculatingText.classList.add('hidden'); initialMessage.classList.remove('hidden'); initialMessage.textContent = "‚òùÔ∏è Primero formula tu enigma existencial."; initialMessage.classList.add('text-red-500', 'font-semibold'); questionInput.focus(); isHolding = false; return;
            }
            isHolding = true;
            initialMessage.classList.add('hidden'); 
            finalResult.classList.add('hidden'); 
            extendedAdviceButton.classList.add('hidden'); 
            extendedAdviceContainer.classList.add('hidden'); 
            extendedAdviceText.textContent = ''; 
            suggestedLinkContainer.classList.add('hidden'); 
            suggestedLinkText.innerHTML = ''; 
            darkOmenContainer.classList.add('hidden'); 
            darkOmenText.textContent = '';
            easterEggDisplay.classList.add('hidden');
            wordGameContainer.classList.add('hidden'); 
            wordGameHint.classList.add('hidden');
            hideAllDynamicIcons(); 
            calculatingText.textContent = "Sintonizando con el cosmos..." 
            calculatingText.classList.remove('hidden'); 
            instructionText.textContent = "Sigue presionando... el destino espera...";
            playCalculatingSound();

            if (isDarkOmenMusicPlaying && darkOmenMusicElement && !darkOmenMusicElement.paused) {
                darkOmenMusicElement.pause();
                darkOmenMusicElement.currentTime = 0;
                isDarkOmenMusicPlaying = false;
            }
        }

        async function handleInteractionEnd() { 
            if (!isHolding) return; 
            stopCalculatingSound();
            isHolding = false;
            
            currentQuestion = questionInput.value.trim(); 
            if (!currentQuestion) { 
                calculatingText.classList.add('hidden');
                initialMessage.textContent = "‚òùÔ∏è El cosmos no puede responder a la nada."; 
                initialMessage.classList.remove('hidden'); 
                return;
            }
            
            const personalityRoll = Math.random() * 100;
            currentOraclePersonality = (personalityRoll <= 80) ? 'dark' : 'angelic';
            console.log("Oracle Personality:", currentOraclePersonality); 

            calculatingText.classList.add('hidden');
            finalResult.classList.remove('hidden');
            askedQuestion.textContent = `Preguntaste: "${currentQuestion}"`;
            probabilityText.textContent = `Calculando Probabilidad...`;
            interpretationText.textContent = 'Conectando con el Or√°culo Gemini...';
            hideAllDynamicIcons();

            await new Promise(resolve => setTimeout(resolve, 300)); 

            currentProbability = Math.floor(Math.random() * 101); 
            probabilityText.textContent = `${currentProbability}%`; 

            const geminiResult = await getGeminiInterpretation(currentQuestion, currentProbability, currentOraclePersonality);
            interpretationText.textContent = geminiResult.message; 

            instructionText.textContent = "El or√°culo ha hablado. ¬øOtra consulta?";
            
            if (!geminiResult.error) {
                extendedAdviceButton.classList.remove('hidden');
            } else {
                extendedAdviceButton.classList.add('hidden'); 
            }
            
            let soundHint;
            hideAllDynamicIcons(); 

            if (currentProbability <= 25) { 
                screamerIcon.classList.remove('hidden');
                screamerIcon.classList.add('animate-custom-shake'); 
                setTimeout(() => screamerIcon.classList.remove('animate-custom-shake'), 500);
                soundHint = 'terror_sound'; 
            } else if (currentProbability <= 40) { 
                doubtIcon.classList.remove('hidden'); 
                soundHint = 'precaution';
            } else if (currentProbability <= 60) { 
                 doubtIcon.classList.remove('hidden');
                soundHint = 'mystery';
            } else if (currentProbability <= 90) { 
                soundHint = (currentOraclePersonality === 'angelic' && currentProbability > 75) ? 'positive_medium' : 'neutral_calm';
            } else { 
                celebrationIcon.classList.remove('hidden');
                soundHint = 'ultimate_fanfare';
            }
            
            playSound(soundHint);
        }
        
        function extractAndDisplaySuggestedLink(adviceText) {
            suggestedLinkContainer.classList.add('hidden');
            suggestedLinkText.innerHTML = ''; 

            let searchTerm = '';
            let linkType = '';
            let displayText = '';

            let songMatch = adviceText.match(/canci√≥n como '([^']*)' de '([^']*)'/i) || adviceText.match(/canci√≥n como '([^']*)'/i) || adviceText.match(/podr√≠as escuchar: ([^.]+)/i);
            let videoMatch = adviceText.match(/video sobre '([^']*)'/i) || adviceText.match(/video acerca de ([^.]+)/i);

            if (songMatch) {
                searchTerm = songMatch[1];
                if (songMatch[2] && songMatch.length > 2 && songMatch[2].toLowerCase() !== 'undefined') searchTerm += " " + songMatch[2]; 
                linkType = 'Canci√≥n sugerida';
            } else if (videoMatch) {
                searchTerm = videoMatch[1];
                linkType = 'Video sugerido';
            }

            if (searchTerm) {
                const searchQuery = encodeURIComponent(searchTerm.trim());
                const youtubeUrl = `https://www.youtube.com/results?search_query=${searchQuery}`; 
                suggestedLinkText.innerHTML = `${linkType}: <a href="${youtubeUrl}" target="_blank" class="suggested-link-button">Buscar "${searchTerm.trim()}" en YouTube</a>`;
                suggestedLinkContainer.classList.remove('hidden');
            } else {
                let curiosityMatch = adviceText.match(/dato curioso: ([^.]+)/i) || adviceText.match(/sab√≠as que([^?]+[.?])/i);
                let storyMatch = adviceText.match(/esto me recuerda a ([^.]+)/i) || adviceText.match(/me recuerda la historia de ([^.]+)/i) ;
                let articleMatch = adviceText.match(/art√≠culo sobre '([^']*)'/i) || adviceText.match(/art√≠culo acerca de ([^.]+)/i);
                let imageMatch = adviceText.match(/imagen de '([^']*)'/i) || adviceText.match(/imagen sobre ([^.]+)/i);

                if (curiosityMatch) {
                    displayText = `Un dato del Or√°culo: ${curiosityMatch[1].trim()}`;
                } else if (storyMatch) {
                    displayText = `Una an√©cdota del Or√°culo: ${storyMatch[1].trim()}`;
                } else if (articleMatch) {
                    displayText = `El Or√°culo sugiere investigar: Un art√≠culo sobre "${articleMatch[1].trim()}"`;
                } else if (imageMatch) {
                    displayText = `El Or√°culo visualiza: Una imagen de "${imageMatch[1].trim()}"`;
                }
                
                if (displayText) {
                    suggestedLinkText.textContent = displayText;
                    suggestedLinkContainer.classList.remove('hidden');
                }
            }
        }

        if (musicToggleButton && backgroundMusic) {
            musicToggleButton.addEventListener('click', () => {
                if (!audioStarted) { 
                    startAudioContext().then(() => {
                        toggleBackgroundMusic();
                    });
                } else {
                    toggleBackgroundMusic();
                }
            });
        }

        function toggleBackgroundMusic() {
            if (!backgroundMusic) return;
            startAudioContext(); 

            if (isDarkOmenMusicPlaying && darkOmenMusicElement && !darkOmenMusicElement.paused) {
                darkOmenMusicElement.pause();
                darkOmenMusicElement.currentTime = 0;
                isDarkOmenMusicPlaying = false;
            }

            if (!backgroundMusic.paused) { 
                backgroundMusic.pause();
                isMusicPlaying = false;
                musicToggleButton.textContent = 'üîä';
            } else { 
                const playPromise = backgroundMusic.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isMusicPlaying = true;
                        musicToggleButton.textContent = 'üîá';
                    }).catch(error => {
                        console.error("Error al intentar reproducir m√∫sica de fondo:", error);
                        isMusicPlaying = false; 
                        musicToggleButton.textContent = 'üîä';
                    });
                }
            }
        }
        
        extendedAdviceButton.addEventListener('click', async () => {
            extendedAdviceButton.classList.add('hidden'); 
            extendedAdviceContainer.classList.remove('hidden');
            loadingExtendedAdvice.classList.remove('hidden');
            extendedAdviceText.textContent = '';
            suggestedLinkContainer.classList.add('hidden'); 
            suggestedLinkText.innerHTML = ''; 

            const adviceResult = await getExtendedGeminiAdvice(currentQuestion, currentProbability, currentInterpretation, currentOraclePersonality);
            
            loadingExtendedAdvice.classList.add('hidden');
            extendedAdviceText.textContent = adviceResult.message; 

            if (!adviceResult.error) {
                extractAndDisplaySuggestedLink(adviceResult.message);
            }
        });

        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function setupWordGame() {
            if (!currentQuestion) {
                wordGameFeedback.textContent = "Primero debes consultar al or√°culo principal.";
                wordGameFeedback.className = "mt-2 text-sm text-red-400";
                wordGameContainer.classList.remove('hidden'); 
                darkOmenContainer.classList.add('hidden'); 
                easterEggDisplay.classList.add('hidden');
                wordGameHint.classList.add('hidden');
                return false; 
            }

            let randomIndex;
            if (wordGamePhrases.length > 1) {
                do {
                    randomIndex = Math.floor(Math.random() * wordGamePhrases.length);
                } while (randomIndex === lastWordGameIndex);
            } else if (wordGamePhrases.length === 1) {
                randomIndex = 0;
            } else { 
                wordGameFeedback.textContent = "No hay presagios disponibles en este momento.";
                wordGameFeedback.className = "mt-2 text-sm text-amber-400";
                wordGameContainer.classList.remove('hidden');
                wordGameHint.classList.add('hidden');
                return false;
            }
            lastWordGameIndex = randomIndex;
            currentWordGame = wordGamePhrases[randomIndex];
            
            wordGamePhrase.textContent = currentWordGame.display;
            wordGameInput.value = '';
            wordGameFeedback.textContent = '';
            wordGameContainer.classList.remove('hidden');
            darkOmenContainer.classList.add('hidden'); 
            easterEggDisplay.classList.add('hidden');

            wordGameHint.textContent = `Pista: ${currentWordGame.answer}`;
            const positions = [
                {top: '0px', left: '5px'}, {top: '0px', right: '5px'}, 
                {bottom: '5px', left: '5px', transform: 'translateX(-50%)', left: '50%'}, 
                {top: '5px', left: '50%', transform: 'translateX(-50%)'} 
            ];
            const randomPos = positions[Math.floor(Math.random() * positions.length)];
            Object.assign(wordGameHint.style, {
                top: 'auto', left: 'auto', right: 'auto', bottom: 'auto', transform: '' 
            });
            Object.assign(wordGameHint.style, randomPos);
            wordGameHint.classList.remove('hidden');
            
            return true; 
        }

        darkOmenButton.addEventListener('click', async () => { 
            await startAudioContext(); 

            if (setupWordGame()) { 
                 if (!backgroundMusic.paused) { 
                    backgroundMusic.pause();
                    isMusicPlaying = false; 
                    musicToggleButton.textContent = 'üîä';
                 }
                if (darkOmenMusicElement) {
                    darkOmenMusicElement.currentTime = 0;
                    const playPromise = darkOmenMusicElement.play();
                    if(playPromise !== undefined){
                        playPromise.then(() => {
                            isDarkOmenMusicPlaying = true;
                        }).catch(e => {
                            console.error("Error al reproducir m√∫sica del presagio:", e);
                            isDarkOmenMusicPlaying = false; 
                        });
                    }
                }
            }
        });

        wordGameCheckButton.addEventListener('click', () => {
            if (!currentWordGame) return; 
            wordGameHint.classList.add('hidden'); 

            const userAnswer = normalizeText(wordGameInput.value.trim()); 
            const correctAnswer = normalizeText(currentWordGame.answer); 

            if (userAnswer === correctAnswer) {
                wordGameFeedback.textContent = "Has descifrado el fragmento... El abismo se abre...";
                wordGameFeedback.className = "mt-2 text-sm text-green-400";
                setTimeout(() => {
                    wordGameContainer.classList.add('hidden');
                    getDarkOmenFromGemini(currentQuestion); 
                }, 1500); 
            } else {
                wordGameFeedback.textContent = "Incorrecto. El destino es esquivo...";
                wordGameFeedback.className = "mt-2 text-sm text-red-400";
                wordGameInput.value = ''; 
                wordGameInput.focus();
                playSound('precaution_high'); 
                setTimeout(() => wordGameHint.classList.remove('hidden'), 500);
            }
        });
        
        directEasterEggButton.addEventListener('click', async () => {
            await startAudioContext();
            console.log("Bot√≥n de Easter Egg directo presionado.");
            
            finalResult.classList.add('hidden');
            extendedAdviceContainer.classList.add('hidden');
            wordGameContainer.classList.add('hidden');
            wordGameHint.classList.add('hidden');
            darkOmenText.classList.add('hidden'); 
            loadingDarkOmen.classList.add('hidden');

            showEasterEgg(); 
            directEasterEggButton.classList.add('hidden'); 

            if (!backgroundMusic.paused) {
                backgroundMusic.pause();
                isMusicPlaying = false;
                musicToggleButton.textContent = 'üîä';
            }
            if (darkOmenMusicElement && !darkOmenMusicElement.paused) { 
                darkOmenMusicElement.pause();
                darkOmenMusicElement.currentTime = 0;
                isDarkOmenMusicPlaying = false;
            }
        });


        probabilityButton.addEventListener('mousedown', handleInteractionStart);
        probabilityButton.addEventListener('mouseup', handleInteractionEnd);
        probabilityButton.addEventListener('mouseleave', () => { if (isHolding) { handleInteractionEnd(); } });
        probabilityButton.addEventListener('touchstart', (event) => { event.preventDefault(); handleInteractionStart(); }, { passive: false }); 
        probabilityButton.addEventListener('touchend', handleInteractionEnd);

        questionInput.addEventListener('input', () => { 
            if (initialMessage.classList.contains('text-red-500')) { 
                initialMessage.textContent = "Ingresa una pregunta y mant√©n presionado el bot√≥n."; 
                initialMessage.classList.remove('text-red-500', 'font-semibold'); 
                initialMessage.classList.remove('hidden'); 
                calculatingText.classList.add('hidden'); 
                finalResult.classList.add('hidden'); 
                extendedAdviceButton.classList.add('hidden');
                extendedAdviceContainer.classList.add('hidden');
                suggestedLinkContainer.classList.add('hidden');
                suggestedLinkText.innerHTML = '';
                darkOmenContainer.classList.add('hidden');
                darkOmenText.textContent = '';
                easterEggDisplay.classList.add('hidden');
                wordGameContainer.classList.add('hidden'); 
                wordGameHint.classList.add('hidden');
                hideAllDynamicIcons(); 
            }
            if (instructionText.textContent.includes("Sigue presionando") || instructionText.textContent.includes("El or√°culo ha hablado")) { 
                instructionText.textContent = "prep√°rate para saber si har√°s eso o no"; 
            }
        });
        
        window.addEventListener('load', () => {
            if (Math.random() < 0.5) { 
                directEasterEggButton.classList.remove('hidden');
                console.log("Bot√≥n de Easter Egg directo HABILITADO esta vez.");
            } else {
                directEasterEggButton.classList.add('hidden');
                 console.log("Bot√≥n de Easter Egg directo DESHABILITADO esta vez.");
            }
        });
    </script>
</body>
</html>
