<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬øTal vez s√≠, o tal vez no? (Con Gemini)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #probabilityButton {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .decorative-icon {
            position: absolute;
            pointer-events: none;
            animation: twinkle 3s infinite ease-in-out;
        }
        .decorative-icon.icon1 { top: -10px; left: -15px; font-size: 1.2em; animation-delay: 0s; }
        .decorative-icon.icon2 { top: 0px; right: -20px; font-size: 0.9em; animation-delay: 0.5s; }
        .decorative-icon.icon3 { bottom: -12px; left: 25%; font-size: 0.8em; animation-delay: 1s; }
        .decorative-icon.icon4 { bottom: -5px; right: 15%; font-size: 1em; animation-delay: 1.5s; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(0.8) rotate(-10deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(10deg); }
        }
        .animate-custom-shake {
            animation: custom-shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
        }
        @keyframes custom-shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }
        #interpretationText, #extendedAdviceText, #suggestedLinkText {
            white-space: pre-wrap; 
            word-break: break-word; 
            text-align: center; 
        }
        #resultContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .suggested-link-button {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background-color: #f59e0b; /* amber-500 */
            color: white;
            border-radius: 0.375rem; /* rounded-md */
            text-decoration: none;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: background-color 0.2s ease-in-out;
        }
        .suggested-link-button:hover {
            background-color: #d97706; /* amber-600 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-300 via-amber-300 to-yellow-300 min-h-screen flex flex-col items-center py-8 px-4 text-gray-800">

    <div class="bg-white/90 backdrop-blur-lg p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-orange-700 relative">
                ¬øTal vez s√≠, o tal vez no?
                <span class="decorative-icon icon1">‚ú®</span>
                <span class="decorative-icon icon2">üî∏</span>
                <span class="decorative-icon icon3">‚≠ê</span>
                <span class="decorative-icon icon4">üîÆ</span>
            </h1>
        </header>

        <main>
            <div class="mb-6">
                <label for="questionInput" class="sr-only">Ingresa tu pregunta:</label>
                <textarea id="questionInput" class="w-full p-3 border border-orange-400 rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none text-lg placeholder-gray-500" rows="3" placeholder="Ej: ¬øDebo adoptar otro gato?"></textarea>
            </div>

            <button id="probabilityButton" class="bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white font-bold text-5xl w-32 h-32 sm:w-36 sm:h-36 rounded-full shadow-lg transition-transform duration-100 ease-in-out active:scale-90 flex items-center justify-center mb-6 focus:outline-none focus:ring-4 focus:ring-orange-300 mx-auto">
                %
            </button>

            <div id="resultContainer" class="p-4 bg-orange-50 rounded-lg shadow-inner w-full"> 
                <div id="dynamicIconSlot" class="absolute top-2 right-2 h-8 w-8 sm:h-10 sm:w-10 opacity-80">
                    <svg id="celebrationIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-yellow-500 animate-pulse"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624L16.5 21.75l-.398-1.126a3.375 3.375 0 00-2.455-2.456L12.75 18l1.126-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.126a3.375 3.375 0 002.456 2.456L20.25 18l-1.126.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
                    <svg id="doubtIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-blue-500 animate-pulse"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>
                    <svg id="screamerIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                </div>

                <p id="calculatingText" class="text-orange-600 text-xl font-semibold hidden animate-pulse">Sintonizando con el cosmos...</p>
                <div id="finalResult" class="hidden w-full"> 
                    <p id="askedQuestion" class="text-gray-700 mb-2 text-md sm:text-lg italic"></p>
                    <p id="probabilityText" class="text-5xl font-bold text-orange-700"></p>
                    <p id="interpretationText" class="text-sm text-amber-800 mt-2 font-medium"></p>
                </div>
                <p id="initialMessage" class="text-gray-500 text-md">Ingresa una pregunta y mant√©n presionado el bot√≥n.</p>

                <button id="extendedAdviceButton" class="hidden mt-4 bg-amber-500 hover:bg-amber-600 active:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform duration-100 ease-in-out active:scale-95 text-sm">
                    ‚ú® Dame m√°s sabidur√≠a
                </button>
                <div id="extendedAdviceContainer" class="hidden mt-3 pt-3 border-t border-orange-200 w-full">
                    <p id="loadingExtendedAdvice" class="text-amber-700 text-sm font-semibold hidden animate-pulse">El Or√°culo busca en los confines del conocimiento...</p>
                    <p id="extendedAdviceText" class="text-sm text-orange-700"></p>
                    <div id="suggestedLinkContainer" class="hidden mt-2">
                        <p id="suggestedLinkText" class="text-xs text-gray-600"></p>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="mt-8">
            <p id="instructionText" class="text-sm text-gray-600 font-medium">prep√°rate para saber si har√°s eso o no</p>
        </footer>
    </div>

    <script>
        const questionInput = document.getElementById('questionInput');
        const probabilityButton = document.getElementById('probabilityButton');
        const calculatingText = document.getElementById('calculatingText'); 
        const finalResult = document.getElementById('finalResult');
        const askedQuestion = document.getElementById('askedQuestion');
        const probabilityText = document.getElementById('probabilityText');
        const interpretationText = document.getElementById('interpretationText'); 
        const instructionText = document.getElementById('instructionText');
        const initialMessage = document.getElementById('initialMessage');

        const celebrationIcon = document.getElementById('celebrationIcon');
        const doubtIcon = document.getElementById('doubtIcon');
        const screamerIcon = document.getElementById('screamerIcon');

        const extendedAdviceButton = document.getElementById('extendedAdviceButton');
        const extendedAdviceContainer = document.getElementById('extendedAdviceContainer');
        const loadingExtendedAdvice = document.getElementById('loadingExtendedAdvice');
        const extendedAdviceText = document.getElementById('extendedAdviceText');
        
        const suggestedLinkContainer = document.getElementById('suggestedLinkContainer');
        const suggestedLinkText = document.getElementById('suggestedLinkText');


        let isHolding = false;
        let audioStarted = false;
        let currentQuestion = "";
        let currentProbability = 0;
        let currentInterpretation = ""; 

        const GEMINI_API_KEY = "AIzaSyDRCB8TMeVcvHcI7pA6D_xExLWZewgARtk"; 

        const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.3 }, volume: -6 }).toDestination();
        const noiseSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }, volume: -10 }).toDestination();
        const FMSynth = new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.01, sustain: 1, release: 0.5 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.5, decay: 0, sustain: 1, release: 0.5 }, volume: -10 }).toDestination();

        async function callGeminiAPI(prompt) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error de Gemini API:', response.status, errorData);
                    let apiErrorMessage = 'No se pudo obtener respuesta.';
                    if (errorData && errorData.error && errorData.error.message) {
                        apiErrorMessage = errorData.error.message;
                    }
                    return { error: true, message: `El Or√°culo dice: "Interferencias c√≥smicas... (${apiErrorMessage})."` };
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 &&
                    data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    return { error: false, message: data.candidates[0].content.parts[0].text.trim() };
                } else {
                    console.warn('Respuesta inesperada de Gemini API:', data);
                    let fallbackMessage = `El Or√°culo murmura algo ininteligible...`;
                    if (data.error && data.error.message) {
                        fallbackMessage = `El Or√°culo est√° confundido: ${data.error.message}.`;
                    }
                    return { error: true, message: fallbackMessage };
                }
            } catch (error) {
                console.error('Error al contactar Gemini API:', error);
                return { error: true, message: `El Or√°culo parece estar de vacaciones en otra dimensi√≥n.` };
            }
        }

        async function getGeminiInterpretation(question, probability) {
            const prompt = `Eres un or√°culo divertido, misterioso y algo exc√©ntrico.
La pregunta espec√≠fica del consultante es: "${question}".
La probabilidad calculada (de 0% a 100%) de que esto suceda es: ${probability}%.
Tu tarea es dar una interpretaci√≥n breve (1-3 frases), creativa y en espa√±ol que est√© DIRECTAMENTE RELACIONADA con el tema de la pregunta "${question}" y que tambi√©n refleje el tono apropiado para la probabilidad de ${probability}%.
Por ejemplo, si la pregunta es "¬øGanar√© la loter√≠a?" y la probabilidad es 5%, tu respuesta deber√≠a ser algo como "Sobre ganar la loter√≠a... las estrellas susurran que es m√°s probable que tu gato aprenda a hablar lat√≠n. Pero, ¬øqui√©n sabe? Los milagros ocurren, aunque raramente con billetes premiados."
Aseg√∫rate de que tu respuesta se sienta como si viniera de un or√°culo y no de una IA.
Tono seg√∫n probabilidad:
- Muy baja (0-20%): Desalentador, con humor negro, o una advertencia ominosa pero divertida, siempre conectada a la pregunta.
- Baja (21-39%): Esc√©ptico, misterioso, o sugiriendo que se necesitar√° un milagro para que suceda lo de la pregunta.
- Media (40-60%): Ambiguo, juguet√≥n, cr√≠ptico, o resaltando la pura aleatoriedad del asunto en relaci√≥n a la pregunta.
- Alta (61-79%): Optimista con un toque de cautela sobre la pregunta, o un consejo peculiar relacionado.
- Muy Alta (80-100%): Entusiasta, casi seguro de que lo de la pregunta suceder√°, o una celebraci√≥n con una peque√±a y extra√±a condici√≥n ligada a la pregunta.
S√© original, evita clich√©s. ¬°Sorpr√©ndeme!`;

            interpretationText.textContent = 'El Or√°culo Gemini consulta los astros distantes...';
            finalResult.classList.remove('hidden'); 
            probabilityText.textContent = `${probability}%`; 
            askedQuestion.textContent = `Preguntaste: "${question}"`;
            
            const result = await callGeminiAPI(prompt);
            currentInterpretation = result.message; 
            return result; 
        }

        async function getExtendedGeminiAdvice(originalQuestion, prob, initialInterpretationFromOracle) {
            if (initialInterpretationFromOracle.startsWith("El Or√°culo dice: \"Interferencias c√≥smicas... (API key not valid")) {
                 return {error: true, message: "El Or√°culo no puede dar m√°s consejos si la conexi√≥n inicial fall√≥ por la clave."};
            }

            const prompt = `Eres el mismo or√°culo divertido y exc√©ntrico. Ya diste una interpretaci√≥n inicial.
Pregunta original: "${originalQuestion}"
Probabilidad calculada: ${prob}%
Tu interpretaci√≥n inicial fue: "${initialInterpretationFromOracle}" 
Ahora, el consultante quiere m√°s sabidur√≠a. Bas√°ndote en todo lo anterior, ofrece UNO de los siguientes (¬°s√© creativo y mant√©n el tono!):
1. Un breve consejo adicional o una reflexi√≥n m√°s profunda sobre la situaci√≥n (1-2 frases concisas).
2. Un peque√±o "ritual" o acci√≥n simb√≥lica divertida y f√°cil que el consultante podr√≠a hacer en relaci√≥n a su pregunta y la probabilidad.
3. Un proverbio o cita (puede ser inventada) que resuene con el momento.

Adicionalmente, si se te ocurre, puedes sugerir sutilmente algo extra y relevante para el momento, como:
- Una canci√≥n (ej: "Para este momento, quiz√°s una canci√≥n como '[Nombre Canci√≥n] de [Artista]'...").
- Un tipo de video (ej: "Un video sobre '[tema del video]' podr√≠a ser inspirador.").
- Una curiosidad o dato divertido (ej: "Como dato curioso, sab√≠as que...").
- Una peque√±a historia o an√©cdota relacionada (ej: "Esto me recuerda a la vez que...").
- La descripci√≥n de un art√≠culo o imagen (ej: "Podr√≠as buscar un art√≠culo sobre '[tema]' o una imagen de '[descripci√≥n de imagen]' para reflexionar.").
Esta sugerencia extra es opcional y debe ser breve y bien integrada con el consejo principal. No intentes crear enlaces HTML ni mostrar im√°genes directamente.

No repitas la probabilidad. S√© conciso y sorprendente. Responde solo con el consejo/ritual/proverbio y, si aplica, la sugerencia extra.`;
            
            return await callGeminiAPI(prompt);
        }
        
        function playSound(soundHint) { 
            if (!audioStarted) return; 
            const now = Tone.now();
            try {
                switch (soundHint) {
                    case 'sad_fail': synth.triggerAttackRelease(["D3", "A2"], "4n", now); break;
                    case 'comic_fail': synth.triggerAttackRelease("G3", "8n", now); synth.triggerAttackRelease("F#3", "8n", now + 0.15); synth.triggerAttackRelease("F3", "4n", now + 0.3); break;
                    case 'precaution': FMSynth.triggerAttackRelease("A2", "8n", now); break;
                    case 'precaution_high': FMSynth.triggerAttackRelease("C3", "16n", now); setTimeout(() => FMSynth.triggerAttackRelease("C3", "16n", now + 0.2), 100); break;
                    case 'terror_sound': noiseSynth.volume.value = -5; noiseSynth.triggerAttackRelease("16n", now); setTimeout(() => noiseSynth.volume.value = -15, 200); break; 
                    case 'mystery': case 'mystery_dark': synth.triggerAttackRelease(["A3", "Eb4", "G#4"], "4n", now, 0.5); break;
                    case 'neutral_ping': synth.triggerAttackRelease("C5", "16n", now, 0.6); break;
                    case 'comic_neutral': synth.triggerAttackRelease("C4", "16n", now); synth.triggerAttackRelease("E4", "16n", now + 0.1); synth.triggerAttackRelease("G3", "8n", now + 0.2); break;
                    case 'neutral_calm': synth.triggerAttackRelease(["C4","E4","G4","C5"], "1n", now, 0.2); break;
                    case 'positive_gentle': case 'positive_calm': case 'mystery_positive': synth.triggerAttackRelease(["G4", "B4", "D5"], "2n", now, 0.7); break;
                    case 'comic_positive': synth.triggerAttackRelease("G4", "8n", now); synth.triggerAttackRelease("C5", "8n", now + 0.15); synth.triggerAttackRelease("E5", "4n", now + 0.3); break;
                    case 'positive_medium': case 'positive_bright': case 'positive_strong': synth.triggerAttackRelease(["C4", "G4", "C5", "E5"], "2n", now, 0.8); break;
                    case 'comic_very_positive': synth.triggerAttackRelease("C5", "16n", now); synth.triggerAttackRelease("E5", "16n", now + 0.05); synth.triggerAttackRelease("G5", "8n", now + 0.1); synth.triggerAttackRelease("C6", "4n", now + 0.2); break;
                    case 'positive_fanfare_short': case 'super_positive': synth.triggerAttackRelease(["G4", "C5", "E5", "G5"], "1n", now, 0.9); break;
                    case 'comic_super_positive': const t = now; ["C4","E4","G4","C5","E5","G5","C6"].forEach((note, i) => { synth.triggerAttackRelease(note, "32n", t + i * 0.05, 0.9); }); break;
                    case 'positive_fanfare_long': case 'ultimate_positive': case 'super_positive_fanfare': case 'ultimate_fanfare': case 'comic_ultimate_win': const t2 = now; ["C4","E4","G4","C5"].forEach((note, i) => synth.triggerAttackRelease(note, "8n", t2 + i*0.1)); setTimeout(()=> {["E5","G5","C6"].forEach((note, i) => synth.triggerAttackRelease(note, "8n", t2 + 0.4 + i*0.1));}, 400); break;
                    default: synth.triggerAttackRelease("C4", "8n", now);
                }
            } catch (e) { console.error("Error al reproducir sonido:", e); }
        }
        
        let calculatingSoundLoop = null;
        function playCalculatingSound() { 
            if (!audioStarted) return;
            if (calculatingSoundLoop) calculatingSoundLoop.stop().dispose();
            calculatingSoundLoop = new Tone.Loop(time => { FMSynth.triggerAttackRelease("C2", "32n", time, 0.2); }, "8n").start(0);
            Tone.Transport.start();
        }
        function stopCalculatingSound() { 
            if (calculatingSoundLoop) { calculatingSoundLoop.stop().dispose(); calculatingSoundLoop = null; }
        }

        async function startAudioContext() {
            if (!audioStarted) {
                try { 
                    await Tone.start();
                    audioStarted = true;
                    console.log("Contexto de audio iniciado.");
                } catch (e) {
                    console.error("Error al iniciar el contexto de audio de Tone.js:", e);
                }
            }
        }

        function hideAllDynamicIcons() {
            celebrationIcon.classList.add('hidden');
            doubtIcon.classList.add('hidden');
            screamerIcon.classList.add('hidden');
            screamerIcon.classList.remove('animate-custom-shake');
        }

        function handleInteractionStart() {
            startAudioContext(); 
            const question = questionInput.value.trim();
            if (!question) { 
                finalResult.classList.add('hidden'); calculatingText.classList.add('hidden'); initialMessage.classList.remove('hidden'); initialMessage.textContent = "‚òùÔ∏è Primero formula tu enigma existencial."; initialMessage.classList.add('text-red-500', 'font-semibold'); questionInput.focus(); isHolding = false; return;
            }
            isHolding = true;
            initialMessage.classList.add('hidden'); 
            finalResult.classList.add('hidden'); 
            extendedAdviceButton.classList.add('hidden'); 
            extendedAdviceContainer.classList.add('hidden'); 
            extendedAdviceText.textContent = ''; 
            suggestedLinkContainer.classList.add('hidden'); 
            suggestedLinkText.innerHTML = ''; 
            hideAllDynamicIcons(); 
            calculatingText.textContent = "Sintonizando con el cosmos..." 
            calculatingText.classList.remove('hidden'); 
            instructionText.textContent = "Sigue presionando... el destino espera...";
            playCalculatingSound();
        }

        async function handleInteractionEnd() { 
            if (!isHolding) return; 
            stopCalculatingSound();
            isHolding = false;
            
            currentQuestion = questionInput.value.trim(); 
            if (!currentQuestion) { 
                calculatingText.classList.add('hidden');
                initialMessage.textContent = "‚òùÔ∏è El cosmos no puede responder a la nada."; 
                initialMessage.classList.remove('hidden'); 
                return;
            }
            
            calculatingText.classList.add('hidden');
            finalResult.classList.remove('hidden');
            askedQuestion.textContent = `Preguntaste: "${currentQuestion}"`;
            probabilityText.textContent = `Calculando Probabilidad...`;
            interpretationText.textContent = 'Conectando con el Or√°culo Gemini...';
            hideAllDynamicIcons();

            await new Promise(resolve => setTimeout(resolve, 300)); 

            currentProbability = Math.floor(Math.random() * 101); 
            probabilityText.textContent = `${currentProbability}%`; 

            const geminiResult = await getGeminiInterpretation(currentQuestion, currentProbability);
            interpretationText.textContent = geminiResult.message; 

            instructionText.textContent = "El or√°culo ha hablado. ¬øOtra consulta?";
            
            if (!geminiResult.error) {
                extendedAdviceButton.classList.remove('hidden');
            } else {
                extendedAdviceButton.classList.add('hidden'); 
            }
            
            let soundHint;
            hideAllDynamicIcons(); 

            if (currentProbability < 20) { 
                screamerIcon.classList.remove('hidden');
                screamerIcon.classList.add('animate-custom-shake'); 
                setTimeout(() => screamerIcon.classList.remove('animate-custom-shake'), 500);
                soundHint = currentProbability <=10 ? 'sad_fail' : 'terror_sound'; 
            } else if (currentProbability >= 40 && currentProbability <= 60) { 
                doubtIcon.classList.remove('hidden');
                soundHint = 'mystery';
            } else if (currentProbability > 90) { 
                celebrationIcon.classList.remove('hidden');
                soundHint = 'ultimate_fanfare';
            } else { 
                if (currentProbability <= 39) soundHint = 'mystery_dark'; 
                else if (currentProbability <= 75) soundHint = 'positive_gentle'; 
                else if (currentProbability <= 90) soundHint = 'positive_medium'; 
                else soundHint = 'neutral_ping'; 
            }
            
            playSound(soundHint);
        }
        
        function extractAndDisplaySuggestedLink(adviceText) {
            suggestedLinkContainer.classList.add('hidden');
            suggestedLinkText.innerHTML = ''; // Limpiar contenido anterior

            let searchTerm = '';
            let linkType = '';
            let displayText = '';

            // Priorizar b√∫squeda de canciones y videos para enlaces de YouTube
            let songMatch = adviceText.match(/canci√≥n como '([^']*)' de '([^']*)'/i) || adviceText.match(/canci√≥n como '([^']*)'/i) || adviceText.match(/podr√≠as escuchar: ([^.]+)/i);
            let videoMatch = adviceText.match(/video sobre '([^']*)'/i) || adviceText.match(/video acerca de ([^.]+)/i);

            if (songMatch) {
                searchTerm = songMatch[1];
                if (songMatch[2] && songMatch.length > 2 && songMatch[2].toLowerCase() !== 'undefined') searchTerm += " " + songMatch[2]; 
                linkType = 'Canci√≥n sugerida';
            } else if (videoMatch) {
                searchTerm = videoMatch[1];
                linkType = 'Video sugerido';
            }

            if (searchTerm) {
                const searchQuery = encodeURIComponent(searchTerm.trim());
                // Corregido el enlace de YouTube
                const youtubeUrl = `https://www.youtube.com/results?search_query=${searchQuery}`;
                suggestedLinkText.innerHTML = `${linkType}: <a href="${youtubeUrl}" target="_blank" class="suggested-link-button">Buscar "${searchTerm.trim()}" en YouTube</a>`;
                suggestedLinkContainer.classList.remove('hidden');
            } else {
                // Si no es canci√≥n/video, buscar otras sugerencias textuales
                let curiosityMatch = adviceText.match(/dato curioso: ([^.]+)/i) || adviceText.match(/sab√≠as que([^?]+[.?])/i);
                let storyMatch = adviceText.match(/esto me recuerda a ([^.]+)/i);
                let articleMatch = adviceText.match(/art√≠culo sobre '([^']*)'/i) || adviceText.match(/art√≠culo acerca de ([^.]+)/i);
                let imageMatch = adviceText.match(/imagen de '([^']*)'/i) || adviceText.match(/imagen sobre ([^.]+)/i);

                if (curiosityMatch) {
                    displayText = `Un dato del Or√°culo: ${curiosityMatch[1].trim()}`;
                } else if (storyMatch) {
                    displayText = `Una an√©cdota del Or√°culo: ${storyMatch[1].trim()}`;
                } else if (articleMatch) {
                    displayText = `El Or√°culo sugiere investigar: Un art√≠culo sobre "${articleMatch[1].trim()}"`;
                } else if (imageMatch) {
                    displayText = `El Or√°culo visualiza: Una imagen de "${imageMatch[1].trim()}"`;
                }
                // Podr√≠amos a√±adir m√°s patrones aqu√≠ si Gemini usa otras frases.

                if (displayText) {
                    suggestedLinkText.textContent = displayText;
                    suggestedLinkContainer.classList.remove('hidden');
                }
            }
        }


        extendedAdviceButton.addEventListener('click', async () => {
            extendedAdviceButton.classList.add('hidden'); 
            extendedAdviceContainer.classList.remove('hidden');
            loadingExtendedAdvice.classList.remove('hidden');
            extendedAdviceText.textContent = '';
            suggestedLinkContainer.classList.add('hidden'); 
            suggestedLinkText.innerHTML = ''; 


            const adviceResult = await getExtendedGeminiAdvice(currentQuestion, currentProbability, currentInterpretation);
            
            loadingExtendedAdvice.classList.add('hidden');
            extendedAdviceText.textContent = adviceResult.message; 

            if (!adviceResult.error) {
                extractAndDisplaySuggestedLink(adviceResult.message);
            }
        });

        probabilityButton.addEventListener('mousedown', handleInteractionStart);
        probabilityButton.addEventListener('mouseup', handleInteractionEnd);
        probabilityButton.addEventListener('mouseleave', () => { if (isHolding) { handleInteractionEnd(); } });
        probabilityButton.addEventListener('touchstart', (event) => { event.preventDefault(); handleInteractionStart(); }, { passive: false }); 
        probabilityButton.addEventListener('touchend', handleInteractionEnd);

        questionInput.addEventListener('input', () => { 
            if (initialMessage.classList.contains('text-red-500')) { 
                initialMessage.textContent = "Ingresa una pregunta y mant√©n presionado el bot√≥n."; 
                initialMessage.classList.remove('text-red-500', 'font-semibold'); 
                initialMessage.classList.remove('hidden'); 
                calculatingText.classList.add('hidden'); 
                finalResult.classList.add('hidden'); 
                extendedAdviceButton.classList.add('hidden');
                extendedAdviceContainer.classList.add('hidden');
                suggestedLinkContainer.classList.add('hidden');
                suggestedLinkText.innerHTML = '';
                hideAllDynamicIcons(); 
            }
            if (instructionText.textContent.includes("Sigue presionando") || instructionText.textContent.includes("El or√°culo ha hablado")) { 
                instructionText.textContent = "prep√°rate para saber si har√°s eso o no"; 
            }
        });
    </script>
</body>
</html>
