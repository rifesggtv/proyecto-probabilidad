<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬øTal vez s√≠, o tal vez no? (Con Gemini)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #probabilityButton {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .decorative-icon {
            position: absolute;
            pointer-events: none;
            animation: twinkle 3s infinite ease-in-out;
        }
        .decorative-icon.icon1 { top: -10px; left: -15px; font-size: 1.2em; animation-delay: 0s; }
        .decorative-icon.icon2 { top: 0px; right: -20px; font-size: 0.9em; animation-delay: 0.5s; }
        .decorative-icon.icon3 { bottom: -12px; left: 25%; font-size: 0.8em; animation-delay: 1s; }
        .decorative-icon.icon4 { bottom: -5px; right: 15%; font-size: 1em; animation-delay: 1.5s; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(0.8) rotate(-10deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(10deg); }
        }
        .animate-custom-shake {
            animation: custom-shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
        }
        @keyframes custom-shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }
        #interpretationText, #extendedAdviceText, #suggestedLinkText, #darkOmenText, #wordGamePhrase {
            white-space: pre-wrap; 
            word-break: break-word; 
            text-align: center; 
        }
        #resultContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .suggested-link-button {
            display: inline-block; margin-top: 8px; padding: 6px 12px;
            background-color: #f59e0b; color: white; border-radius: 0.375rem; 
            text-decoration: none; font-size: 0.875rem; font-weight: 600; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: background-color 0.2s ease-in-out;
        }
        .suggested-link-button:hover { background-color: #d97706; }
        
        #musicToggleButton {
            position: fixed; bottom: 20px; right: 20px; background-color: #6b7280; 
            color: white; padding: 10px; border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000;
        }
        #musicToggleButton:hover { background-color: #4b5563; }

        #darkOmenButton {
            margin-top: 20px;
            background-color: #1f2937; 
            color: #fca5a5; 
            border: 1px solid #ef4444; 
        }
        #darkOmenButton:hover {
            background-color: #111827; 
            color: #f87171; 
        }
        /* Estilos para el juego de completar palabra */
        #wordGameContainer {
            margin-top: 20px;
            padding: 15px;
            background-color: #374151; /* gray-700 */
            border: 1px solid #ef4444; /* red-500 */
            border-radius: 0.5rem;
            text-align: center;
        }
        #wordGamePhrase {
            color: #fde68a; /* amber-200 */
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        #wordGameInput {
            padding: 8px;
            border-radius: 0.25rem;
            border: 1px solid #eab308; /* yellow-500 */
            background-color: #4b5563; /* gray-600 */
            color: white;
            margin-right: 10px;
            width: calc(100% - 130px); /* Ajustar ancho */
        }
        #wordGameCheckButton {
            padding: 8px 15px;
            background-color: #eab308; /* yellow-500 */
            color: #1f2937; /* gray-800 */
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: 600;
        }
        #wordGameCheckButton:hover {
            background-color: #f59e0b; /* amber-500 */
        }
        #wordGameFeedback {
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-300 via-amber-300 to-yellow-300 min-h-screen flex flex-col items-center py-8 px-4 text-gray-800">
   
    <audio id="backgroundMusic" loop>
        <source src="https://audionautix.com/Music/DarkMystery.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
    </audio>
    <button id="musicToggleButton">üîä</button> 
    
    <div class="bg-white/90 backdrop-blur-lg p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-orange-700 relative">
                ¬øTal vez s√≠, o tal vez no?
                <span class="decorative-icon icon1">‚ú®</span>
                <span class="decorative-icon icon2">üî∏</span>
                <span class="decorative-icon icon3">‚≠ê</span>
                <span class="decorative-icon icon4">üîÆ</span>
            </h1>
        </header>

        <main>
            <div class="mb-6">
                <label for="questionInput" class="sr-only">Ingresa tu pregunta:</label>
                <textarea id="questionInput" class="w-full p-3 border border-orange-400 rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none text-lg placeholder-gray-500" rows="3" placeholder="Ej: ¬øDebo adoptar otro gato?"></textarea>
            </div>

            <button id="probabilityButton" class="bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white font-bold text-5xl w-32 h-32 sm:w-36 sm:h-36 rounded-full shadow-lg transition-transform duration-100 ease-in-out active:scale-90 flex items-center justify-center mb-6 focus:outline-none focus:ring-4 focus:ring-orange-300 mx-auto">
                %
            </button>

            <div id="resultContainer" class="p-4 bg-orange-50 rounded-lg shadow-inner w-full"> 
                <div id="dynamicIconSlot" class="absolute top-2 right-2 h-8 w-8 sm:h-10 sm:w-10 opacity-80">
                    <svg id="celebrationIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-yellow-500 animate-pulse"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624L16.5 21.75l-.398-1.126a3.375 3.375 0 00-2.455-2.456L12.75 18l1.126-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.126a3.375 3.375 0 002.456 2.456L20.25 18l-1.126.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
                    <svg id="doubtIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-blue-500 animate-pulse"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>
                    <svg id="screamerIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden h-full w-full text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                </div>

                <p id="calculatingText" class="text-orange-600 text-xl font-semibold hidden animate-pulse">Sintonizando con el cosmos...</p>
                <div id="finalResult" class="hidden w-full"> 
                    <p id="askedQuestion" class="text-gray-700 mb-2 text-md sm:text-lg italic"></p>
                    <p id="probabilityText" class="text-5xl font-bold text-orange-700"></p>
                    <p id="interpretationText" class="text-sm text-amber-800 mt-2 font-medium"></p>
                </div>
                <p id="initialMessage" class="text-gray-500 text-md">Ingresa una pregunta y mant√©n presionado el bot√≥n.</p>

                <button id="extendedAdviceButton" class="hidden mt-4 bg-amber-500 hover:bg-amber-600 active:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform duration-100 ease-in-out active:scale-95 text-sm">
                    ‚ú® Dame m√°s sabidur√≠a
                </button>
                <div id="extendedAdviceContainer" class="hidden mt-3 pt-3 border-t border-orange-200 w-full">
                    <p id="loadingExtendedAdvice" class="text-amber-700 text-sm font-semibold hidden animate-pulse">El Or√°culo busca en los confines del conocimiento...</p>
                    <p id="extendedAdviceText" class="text-sm text-orange-700"></p>
                    <div id="suggestedLinkContainer" class="hidden mt-2">
                        <p id="suggestedLinkText" class="text-xs text-gray-600"></p>
                    </div>
                </div>
                 <div id="darkOmenContainer" class="hidden mt-4 pt-4 border-t-2 border-red-700 w-full">
                    <p id="loadingDarkOmen" class="text-red-700 text-sm font-semibold hidden animate-pulse">El Abismo susurra...</p>
                    <p id="darkOmenText" class="text-sm text-red-800 font-mono"></p>
                </div>
            </div>
        </main>
        
        <footer class="mt-8">
            <p id="instructionText" class="text-sm text-gray-600 font-medium">prep√°rate para saber si har√°s eso o no</p>
        </footer>

        <button id="darkOmenButton" class="mt-6 w-full py-3 px-4 rounded-lg shadow-lg font-semibold text-sm transition-colors duration-150 ease-in-out">
            No le des click
        </button>

        <div id="wordGameContainer" class="hidden mt-4">
            <p class="text-red-300 text-sm mb-2">Has elegido asomarte al abismo. Completa el presagio para ver lo que te espera...</p>
            <p id="wordGamePhrase" class="text-lg"></p>
            <input type="text" id="wordGameInput" class="mt-2" placeholder="Escribe aqu√≠ la palabra...">
            <button id="wordGameCheckButton" class="mt-2">Revelar Destino</button>
            <p id="wordGameFeedback" class="mt-2 text-sm"></p>
        </div>
    </div>

    <script>
        const questionInput = document.getElementById('questionInput');
        const probabilityButton = document.getElementById('probabilityButton');
        const calculatingText = document.getElementById('calculatingText'); 
        const finalResult = document.getElementById('finalResult');
        const askedQuestion = document.getElementById('askedQuestion');
        const probabilityText = document.getElementById('probabilityText');
        const interpretationText = document.getElementById('interpretationText'); 
        const instructionText = document.getElementById('instructionText');
        const initialMessage = document.getElementById('initialMessage');

        const celebrationIcon = document.getElementById('celebrationIcon');
        const doubtIcon = document.getElementById('doubtIcon');
        const screamerIcon = document.getElementById('screamerIcon');

        const extendedAdviceButton = document.getElementById('extendedAdviceButton');
        const extendedAdviceContainer = document.getElementById('extendedAdviceContainer');
        const loadingExtendedAdvice = document.getElementById('loadingExtendedAdvice');
        const extendedAdviceText = document.getElementById('extendedAdviceText');
        
        const suggestedLinkContainer = document.getElementById('suggestedLinkContainer');
        const suggestedLinkText = document.getElementById('suggestedLinkText');

        // Elementos para el Presagio Oscuro y Juego de Palabras
        const darkOmenButton = document.getElementById('darkOmenButton');
        const wordGameContainer = document.getElementById('wordGameContainer');
        const wordGamePhrase = document.getElementById('wordGamePhrase');
        const wordGameInput = document.getElementById('wordGameInput');
        const wordGameCheckButton = document.getElementById('wordGameCheckButton');
        const wordGameFeedback = document.getElementById('wordGameFeedback');
        const darkOmenContainer = document.getElementById('darkOmenContainer');
        const loadingDarkOmen = document.getElementById('loadingDarkOmen');
        const darkOmenText = document.getElementById('darkOmenText');
        
        const backgroundMusic = document.getElementById('backgroundMusic');
        const musicToggleButton = document.getElementById('musicToggleButton');
        let isMusicPlaying = false;

        let isHolding = false;
        let audioStarted = false;
        let currentQuestion = "";
        let currentProbability = 0;
        let currentInterpretation = ""; 
        let currentWordGame = null;

        const GEMINI_API_KEY = "AIzaSyDRCB8TMeVcvHcI7pA6D_xExLWZewgARtk"; 

        // --- Lista de Frases para el Juego de Palabras ---
        const wordGamePhrases = [
            { display: "No conf√≠es en las s_ _ _ _ _ _ brillantes.", answer: "sonrisas" , fullPhrase: "No conf√≠es en las sonrisas brillantes."},
            { display: "El s_ _ _ _ _ _ _ a veces es el peor consejero.", answer: "silencio", fullPhrase: "El silencio a veces es el peor consejero."},
            { display: "Las p_ _ _ _ _ _ _ tienen ecos inesperados.", answer: "palabras", fullPhrase: "Las palabras tienen ecos inesperados."},
            { display: "Cuidado con los c_ _ _ _ _ _ que parecen demasiado rectos.", answer: "caminos", fullPhrase: "Cuidado con los caminos que parecen demasiado rectos."},
            { display: "Un e_ _ _ _ _ puede ocultar m√°s de lo que muestra.", answer: "espejo", fullPhrase: "Un espejo puede ocultar m√°s de lo que muestra."},
            { display: "La v_ _ _ _ _ se esconde tras muchos velos.", answer: "verdad", fullPhrase: "La verdad se esconde tras muchos velos."}
        ];


        const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.3 }, volume: -6 }).toDestination();
        const noiseSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }, volume: -10 }).toDestination();
        const FMSynth = new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.01, sustain: 1, release: 0.5 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.5, decay: 0, sustain: 1, release: 0.5 }, volume: -10 }).toDestination();

        async function callGeminiAPI(prompt) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error de Gemini API:', response.status, errorData);
                    let apiErrorMessage = 'No se pudo obtener respuesta.';
                    if (errorData && errorData.error && errorData.error.message) {
                        apiErrorMessage = errorData.error.message;
                    }
                    return { error: true, message: `El Or√°culo dice: "Interferencias c√≥smicas... (${apiErrorMessage})."` };
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 &&
                    data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    return { error: false, message: data.candidates[0].content.parts[0].text.trim() };
                } else {
                    console.warn('Respuesta inesperada de Gemini API:', data);
                    let fallbackMessage = `El Or√°culo murmura algo ininteligible...`;
                    if (data.error && data.error.message) {
                        fallbackMessage = `El Or√°culo est√° confundido: ${data.error.message}.`;
                    }
                    return { error: true, message: fallbackMessage };
                }
            } catch (error) {
                console.error('Error al contactar Gemini API:', error);
                return { error: true, message: `El Or√°culo parece estar de vacaciones en otra dimensi√≥n.` };
            }
        }

        async function getGeminiInterpretation(question, probability) {
            const prompt = `Eres un or√°culo muy particular: directo, a veces oscuro, y con un toque de humor negro y terror, a veces terror psicologico, tambien eres muy comico, ironico, y satirico, si notas alguna falta de ortografia en la pregunta, la recalcas con una broma y luego sigues siendo el oraculo.
La pregunta espec√≠fica del consultante es: "${question}".
La probabilidad calculada (de 0% a 100%) de que esto suceda es: ${probability}%.

Tu tarea es dar una interpretaci√≥n breve (1-2 frases M√ÅXIMO), contundente y en espa√±ol que est√© DIRECTAMENTE RELACIONADA con el tema de la pregunta "${question}".
El tono debe ser MUY espec√≠fico seg√∫n la probabilidad:
- 0-10% (Extremadamente Baja): Respuesta con terror psicol√≥gico sutil, desesperanzadora y desgarradora. Ej: "Sobre '${question}'... las sombras susurran que ese camino solo lleva a un eco vac√≠o. No mires atr√°s."
- 11-25% (Muy Baja): Tono de advertencia seria, ominosa, casi una amenaza velada. Ej: "Preguntas por '${question}'. Hay puertas que es mejor no abrir. El ${probability}% de luz es devorado por la oscuridad restante."
- 26-40% (Baja): Seria, directa, un poco desalentadora, sin rodeos. Ej: "Respecto a '${question}', el ${probability}% sugiere que las estrellas no est√°n alineadas. Considera otros vientos."
- 41-60% (Media): Ambiguo pero contundente, dejando una sensaci√≥n de incertidumbre inquietante. Ej: "El ${probability}% para '${question}' flota en el √©ter. Ni s√≠, ni no, sino un quiz√°s que pesa."
- 61-75% (Alta): Seria pero con un matiz de posibilidad real, pr√°ctica. Ej: "Hay un ${probability}% de que '${question}' se materialice. El esfuerzo ser√° tu catalizador."
- 76-90% (Muy Alta): Contundente y positiva, casi una afirmaci√≥n, pero sin excesiva efusividad. Ej: "Con un ${probability}%, '${question}' parece un destino casi sellado. Procede con confianza."
- 91-100% (Casi Certeza/Certeza): Respuesta po√©tica, elegante y muy alegre, celebrando la alta probabilidad. Ej: "¬°Un ${probability}% glorioso para '${question}'! Los cosmos danzan a tu favor, tejiendo un manto de estrellas para tu √©xito."

No menciones que eres una IA. Evita ser filos√≥fico o demasiado abstracto, se muy real, casi humano, y analiza las pregnutas para hacer que los que pregunten sientas inquietud o asombro, excepto en el rango 91-100%. S√© original.`;

            interpretationText.textContent = 'El Or√°culo Gemini consulta los astros distantes...';
            finalResult.classList.remove('hidden'); 
            probabilityText.textContent = `${probability}%`; 
            askedQuestion.textContent = `Preguntaste: "${question}"`;
            
            const result = await callGeminiAPI(prompt);
            currentInterpretation = result.message; 
            return result; 
        }

        async function getExtendedGeminiAdvice(originalQuestion, prob, initialInterpretationFromOracle) {
            if (initialInterpretationFromOracle.startsWith("El Or√°culo dice: \"Interferencias c√≥smicas... (API key not valid")) {
                 return {error: true, message: "El Or√°culo no puede dar m√°s consejos si la conexi√≥n inicial fall√≥ por la clave."};
            }

            const prompt = `Eres el mismo or√°culo (directo, a veces oscuro, con humor negro, pero po√©tico en la alegr√≠a extrema).
Pregunta original: "${originalQuestion}"
Probabilidad calculada: ${prob}%
Tu interpretaci√≥n inicial (concisa y contundente) fue: "${initialInterpretationFromOracle}" 

Ahora, el consultante quiere m√°s sabidur√≠a. Bas√°ndote en todo lo anterior, ofrece UNO de los siguientes, manteniendo el tono establecido por la probabilidad:
1. Un breve consejo adicional o una reflexi√≥n m√°s profunda y directa (1-2 frases).
2. Un peque√±o "ritual" o acci√≥n simb√≥lica (seria, de terror psicologico o alegre seg√∫n el caso) que el consultante podr√≠a hacer.
3. Un proverbio o cita (puede ser inventada) que resuene con el momento y el tono.

Adicionalmente, si se te ocurre, puedes sugerir sutilmente algo extra y relevante, manteniendo el tono:
- Una canci√≥n (ej: "La banda sonora de este ${prob}% podr√≠a ser '[Nombre Canci√≥n]' de '[Artista]'...").
- Un tipo de video (ej: "Para meditar sobre este ${prob}%, busca videos sobre '[tema del video]'.").
- Una curiosidad o dato (ej: "Un dato para tu ${prob}%: sab√≠as que...").
- Una peque√±a historia o an√©cdota (ej: "Este ${prob}% me recuerda a la vez que...").
- La descripci√≥n de un art√≠culo o imagen (ej: "Visualiza un art√≠culo sobre '[tema]' o una imagen de '[descripci√≥n]' para este ${prob}%.").
Esta sugerencia extra es opcional y debe ser breve. No crees enlaces HTML ni muestres im√°genes.

No repitas la probabilidad. S√© conciso y sorprendente. Responde solo con el consejo/ritual/proverbio y, si aplica, la sugerencia extra.`;
            
            return await callGeminiAPI(prompt);
        }

        async function getDarkOmenFromGemini(question) {
            const prompt = `Eres la voz del Abismo, un or√°culo de presagios oscuros y verdades inc√≥modas.
La pregunta del consultante fue: "${question}".
Olvida cualquier probabilidad anterior. Ahora vas a revelar un presagio alternativo, una verdad m√°s sombr√≠a.
Tu presagio debe ser:
1.  Breve (1-3 frases).
2.  En espa√±ol, con un tono de terror psicol√≥gico sutil, ominoso e inquietante.
3.  Debe ofrecer una "probabilidad" o perspectiva diferente sobre "${question}", usualmente m√°s negativa o incierta.
4.  Debe incluir advertencias MUY ESPEC√çFICAS sobre 2 o 3 cosas con las que el consultante debe tener extremo cuidado en relaci√≥n a su pregunta. Estas advertencias deben ser concretas y perturbadoras.
    Ejemplos de advertencias espec√≠ficas (adapta al tema de la pregunta):
    - "Cuidado con las palabras no dichas en habitaciones silenciosas."
    - "No conf√≠es en los reflejos despu√©s de medianoche."
    - "El sonido de la lluvia sobre el cristal podr√≠a traer m√°s que agua."
    - "Un objeto perdido podr√≠a ser una invitaci√≥n."
    - "Presta atenci√≥n a los sue√±os donde los n√∫meros aparecen al rev√©s."
No digas que eres IA. S√© la personificaci√≥n de una entidad antigua y perturbadora.
Ejemplo si la pregunta fue "¬øConseguir√© el trabajo?": "Sobre ese trabajo... el Abismo susurra un 13% de posibilidades de que sea lo que esperas, y un 87% de que sea una trampa de espejos. Ten cuidado con las ofertas demasiado generosas, con las sonrisas que no llegan a los ojos y con cualquier documento firmado bajo una luz parpadeante."`;

            loadingDarkOmen.classList.remove('hidden');
            darkOmenText.textContent = '';
            darkOmenContainer.classList.remove('hidden');

            const result = await callGeminiAPI(prompt);
            
            loadingDarkOmen.classList.add('hidden');
            darkOmenText.textContent = result.message;
            playSound('terror_sound'); 
        }
        
        function playSound(soundHint) { 
            if (!audioStarted) return; 
            const now = Tone.now();
            try {
                switch (soundHint) {
                    case 'sad_fail': synth.triggerAttackRelease(["D3", "A2"], "4n", now); break;
                    case 'comic_fail': synth.triggerAttackRelease("G3", "8n", now); synth.triggerAttackRelease("F#3", "8n", now + 0.15); synth.triggerAttackRelease("F3", "4n", now + 0.3); break;
                    case 'precaution': FMSynth.triggerAttackRelease("A2", "8n", now); break;
                    case 'precaution_high': FMSynth.triggerAttackRelease("C3", "16n", now); setTimeout(() => FMSynth.triggerAttackRelease("C3", "16n", now + 0.2), 100); break;
                    case 'terror_sound': noiseSynth.volume.value = -5; noiseSynth.triggerAttackRelease("16n", now); setTimeout(() => noiseSynth.volume.value = -15, 200); break; 
                    case 'mystery': case 'mystery_dark': synth.triggerAttackRelease(["A3", "Eb4", "G#4"], "4n", now, 0.5); break;
                    case 'neutral_ping': synth.triggerAttackRelease("C5", "16n", now, 0.6); break;
                    case 'comic_neutral': synth.triggerAttackRelease("C4", "16n", now); synth.triggerAttackRelease("E4", "16n", now + 0.1); synth.triggerAttackRelease("G3", "8n", now + 0.2); break;
                    case 'neutral_calm': synth.triggerAttackRelease(["C4","E4","G4","C5"], "1n", now, 0.2); break;
                    case 'positive_gentle': case 'positive_calm': case 'mystery_positive': synth.triggerAttackRelease(["G4", "B4", "D5"], "2n", now, 0.7); break;
                    case 'comic_positive': synth.triggerAttackRelease("G4", "8n", now); synth.triggerAttackRelease("C5", "8n", now + 0.15); synth.triggerAttackRelease("E5", "4n", now + 0.3); break;
                    case 'positive_medium': case 'positive_bright': case 'positive_strong': synth.triggerAttackRelease(["C4", "G4", "C5", "E5"], "2n", now, 0.8); break;
                    case 'comic_very_positive': synth.triggerAttackRelease("C5", "16n", now); synth.triggerAttackRelease("E5", "16n", now + 0.05); synth.triggerAttackRelease("G5", "8n", now + 0.1); synth.triggerAttackRelease("C6", "4n", now + 0.2); break;
                    case 'positive_fanfare_short': case 'super_positive': synth.triggerAttackRelease(["G4", "C5", "E5", "G5"], "1n", now, 0.9); break;
                    case 'comic_super_positive': const t = now; ["C4","E4","G4","C5","E5","G5","C6"].forEach((note, i) => { synth.triggerAttackRelease(note, "32n", t + i * 0.05, 0.9); }); break;
                    case 'positive_fanfare_long': case 'ultimate_positive': case 'super_positive_fanfare': case 'ultimate_fanfare': case 'comic_ultimate_win': const t2 = now; ["C4","E4","G4","C5"].forEach((note, i) => synth.triggerAttackRelease(note, "8n", t2 + i*0.1)); setTimeout(()=> {["E5","G5","C6"].forEach((note, i) => synth.triggerAttackRelease(note, "8n", t2 + 0.4 + i*0.1));}, 400); break;
                    default: synth.triggerAttackRelease("C4", "8n", now);
                }
            } catch (e) { console.error("Error al reproducir sonido:", e); }
        }
        
        let calculatingSoundLoop = null;
        function playCalculatingSound() { 
            if (!audioStarted) return;
            if (calculatingSoundLoop) calculatingSoundLoop.stop().dispose();
            calculatingSoundLoop = new Tone.Loop(time => { FMSynth.triggerAttackRelease("C2", "32n", time, 0.2); }, "8n").start(0);
            Tone.Transport.start();
        }
        function stopCalculatingSound() { 
            if (calculatingSoundLoop) { calculatingSoundLoop.stop().dispose(); calculatingSoundLoop = null; }
        }

        async function startAudioContext() {
            if (!audioStarted) {
                try { 
                    await Tone.start();
                    audioStarted = true;
                    console.log("Contexto de audio iniciado.");
                } catch (e) {
                    console.error("Error al iniciar el contexto de audio de Tone.js:", e);
                }
            }
        }

        function hideAllDynamicIcons() {
            celebrationIcon.classList.add('hidden');
            doubtIcon.classList.add('hidden');
            screamerIcon.classList.add('hidden');
            screamerIcon.classList.remove('animate-custom-shake');
        }

        function handleInteractionStart() {
            startAudioContext(); 
            const question = questionInput.value.trim();
            if (!question) { 
                finalResult.classList.add('hidden'); calculatingText.classList.add('hidden'); initialMessage.classList.remove('hidden'); initialMessage.textContent = "‚òùÔ∏è Primero formula tu enigma existencial."; initialMessage.classList.add('text-red-500', 'font-semibold'); questionInput.focus(); isHolding = false; return;
            }
            isHolding = true;
            initialMessage.classList.add('hidden'); 
            finalResult.classList.add('hidden'); 
            extendedAdviceButton.classList.add('hidden'); 
            extendedAdviceContainer.classList.add('hidden'); 
            extendedAdviceText.textContent = ''; 
            suggestedLinkContainer.classList.add('hidden'); 
            suggestedLinkText.innerHTML = ''; 
            darkOmenContainer.classList.add('hidden'); 
            darkOmenText.textContent = '';
            wordGameContainer.classList.add('hidden'); // Ocultar juego si estaba abierto
            hideAllDynamicIcons(); 
            calculatingText.textContent = "Sintonizando con el cosmos..." 
            calculatingText.classList.remove('hidden'); 
            instructionText.textContent = "Sigue presionando... el destino espera...";
            playCalculatingSound();
        }

        async function handleInteractionEnd() { 
            if (!isHolding) return; 
            stopCalculatingSound();
            isHolding = false;
            
            currentQuestion = questionInput.value.trim(); 
            if (!currentQuestion) { 
                calculatingText.classList.add('hidden');
                initialMessage.textContent = "‚òùÔ∏è El cosmos no puede responder a la nada."; 
                initialMessage.classList.remove('hidden'); 
                return;
            }
            
            calculatingText.classList.add('hidden');
            finalResult.classList.remove('hidden');
            askedQuestion.textContent = `Preguntaste: "${currentQuestion}"`;
            probabilityText.textContent = `Calculando Probabilidad...`;
            interpretationText.textContent = 'Conectando con el Or√°culo Gemini...';
            hideAllDynamicIcons();

            await new Promise(resolve => setTimeout(resolve, 300)); 

            currentProbability = Math.floor(Math.random() * 101); 
            probabilityText.textContent = `${currentProbability}%`; 

            const geminiResult = await getGeminiInterpretation(currentQuestion, currentProbability);
            interpretationText.textContent = geminiResult.message; 

            instructionText.textContent = "El or√°culo ha hablado. ¬øOtra consulta?";
            
            if (!geminiResult.error) {
                extendedAdviceButton.classList.remove('hidden');
            } else {
                extendedAdviceButton.classList.add('hidden'); 
            }
            
            let soundHint;
            hideAllDynamicIcons(); 

            if (currentProbability <= 25) { 
                screamerIcon.classList.remove('hidden');
                screamerIcon.classList.add('animate-custom-shake'); 
                setTimeout(() => screamerIcon.classList.remove('animate-custom-shake'), 500);
                soundHint = 'terror_sound'; 
            } else if (currentProbability <= 40) { 
                doubtIcon.classList.remove('hidden'); 
                soundHint = 'precaution';
            } else if (currentProbability <= 60) { 
                 doubtIcon.classList.remove('hidden');
                soundHint = 'mystery';
            } else if (currentProbability <= 90) { 
                soundHint = 'neutral_calm';
            } else { 
                celebrationIcon.classList.remove('hidden');
                soundHint = 'ultimate_fanfare';
            }
            
            playSound(soundHint);
        }
        
        function extractAndDisplaySuggestedLink(adviceText) {
            suggestedLinkContainer.classList.add('hidden');
            suggestedLinkText.innerHTML = ''; 

            let searchTerm = '';
            let linkType = '';
            let displayText = '';

            let songMatch = adviceText.match(/canci√≥n como '([^']*)' de '([^']*)'/i) || adviceText.match(/canci√≥n como '([^']*)'/i) || adviceText.match(/podr√≠as escuchar: ([^.]+)/i);
            let videoMatch = adviceText.match(/video sobre '([^']*)'/i) || adviceText.match(/video acerca de ([^.]+)/i);

            if (songMatch) {
                searchTerm = songMatch[1];
                if (songMatch[2] && songMatch.length > 2 && songMatch[2].toLowerCase() !== 'undefined') searchTerm += " " + songMatch[2]; 
                linkType = 'Canci√≥n sugerida';
            } else if (videoMatch) {
                searchTerm = videoMatch[1];
                linkType = 'Video sugerido';
            }

            if (searchTerm) {
                const searchQuery = encodeURIComponent(searchTerm.trim());
                const youtubeUrl = `https://www.youtube.com/results?search_query=${searchQuery}`; 
                suggestedLinkText.innerHTML = `${linkType}: <a href="${youtubeUrl}" target="_blank" class="suggested-link-button">Buscar "${searchTerm.trim()}" en YouTube</a>`;
                suggestedLinkContainer.classList.remove('hidden');
            } else {
                let curiosityMatch = adviceText.match(/dato curioso: ([^.]+)/i) || adviceText.match(/sab√≠as que([^?]+[.?])/i);
                let storyMatch = adviceText.match(/esto me recuerda a ([^.]+)/i) || adviceText.match(/me recuerda la historia de ([^.]+)/i) ;
                let articleMatch = adviceText.match(/art√≠culo sobre '([^']*)'/i) || adviceText.match(/art√≠culo acerca de ([^.]+)/i);
                let imageMatch = adviceText.match(/imagen de '([^']*)'/i) || adviceText.match(/imagen sobre ([^.]+)/i);

                if (curiosityMatch) {
                    displayText = `Un dato del Or√°culo: ${curiosityMatch[1].trim()}`;
                } else if (storyMatch) {
                    displayText = `Una an√©cdota del Or√°culo: ${storyMatch[1].trim()}`;
                } else if (articleMatch) {
                    displayText = `El Or√°culo sugiere investigar: Un art√≠culo sobre "${articleMatch[1].trim()}"`;
                } else if (imageMatch) {
                    displayText = `El Or√°culo visualiza: Una imagen de "${imageMatch[1].trim()}"`;
                }
                
                if (displayText) {
                    suggestedLinkText.textContent = displayText;
                    suggestedLinkContainer.classList.remove('hidden');
                }
            }
        }

        if (musicToggleButton && backgroundMusic) {
            musicToggleButton.addEventListener('click', () => {
                if (!audioStarted) { 
                    startAudioContext().then(() => {
                        toggleBackgroundMusic();
                    });
                } else {
                    toggleBackgroundMusic();
                }
            });
        }

        function toggleBackgroundMusic() {
            if (!backgroundMusic) return;
            if (isMusicPlaying) { 
                backgroundMusic.pause();
                musicToggleButton.textContent = 'üîä'; 
            } else {
                backgroundMusic.play().catch(e => console.error("Error al reproducir m√∫sica:", e)); 
                musicToggleButton.textContent = 'üîá'; 
            }
            isMusicPlaying = !isMusicPlaying; 
        }
        
        extendedAdviceButton.addEventListener('click', async () => {
            extendedAdviceButton.classList.add('hidden'); 
            extendedAdviceContainer.classList.remove('hidden');
            loadingExtendedAdvice.classList.remove('hidden');
            extendedAdviceText.textContent = '';
            suggestedLinkContainer.classList.add('hidden'); 
            suggestedLinkText.innerHTML = ''; 

            const adviceResult = await getExtendedGeminiAdvice(currentQuestion, currentProbability, currentInterpretation);
            
            loadingExtendedAdvice.classList.add('hidden');
            extendedAdviceText.textContent = adviceResult.message; 

            if (!adviceResult.error) {
                extractAndDisplaySuggestedLink(adviceResult.message);
            }
        });

        // --- L√≥gica del Juego de Completar Palabra y Presagio Oscuro ---
        function setupWordGame() {
            if (!currentQuestion) {
                wordGameFeedback.textContent = "Primero debes consultar al or√°culo principal.";
                wordGameFeedback.className = "mt-2 text-sm text-red-400";
                wordGameContainer.classList.remove('hidden'); // Mostrar para ver el mensaje
                return false; // Indicar que no se pudo configurar
            }
            currentWordGame = wordGamePhrases[Math.floor(Math.random() * wordGamePhrases.length)];
            wordGamePhrase.textContent = currentWordGame.display;
            wordGameInput.value = '';
            wordGameFeedback.textContent = '';
            wordGameContainer.classList.remove('hidden');
            darkOmenContainer.classList.add('hidden'); // Ocultar presagio si estaba visible
            return true; // Juego configurado
        }

        darkOmenButton.addEventListener('click', () => {
            // Si el juego ya est√° visible, quiz√°s no hacer nada o reiniciarlo
            if (wordGameContainer.classList.contains('hidden')) {
                setupWordGame();
            } else {
                // Opcional: reiniciar si ya est√° visible y se vuelve a clickear
                 if(!setupWordGame()) return; // No continuar si no hay pregunta
            }
        });

        wordGameCheckButton.addEventListener('click', () => {
            if (!currentWordGame) return; // No hay juego activo

            const userAnswer = wordGameInput.value.trim().toLowerCase();
            const correctAnswer = currentWordGame.answer.toLowerCase();

            if (userAnswer === correctAnswer) {
                wordGameFeedback.textContent = "Has descifrado el fragmento... El abismo se abre...";
                wordGameFeedback.className = "mt-2 text-sm text-green-400";
                // Ocultar el juego de palabras despu√©s de ganar
                setTimeout(() => {
                    wordGameContainer.classList.add('hidden');
                    getDarkOmenFromGemini(currentQuestion);
                }, 1500); // Peque√±a demora para leer el feedback
            } else {
                wordGameFeedback.textContent = "Incorrecto. El destino es esquivo...";
                wordGameFeedback.className = "mt-2 text-sm text-red-400";
                wordGameInput.focus();
                playSound('precaution_high'); // Sonido de error/advertencia
            }
        });


        probabilityButton.addEventListener('mousedown', handleInteractionStart);
        probabilityButton.addEventListener('mouseup', handleInteractionEnd);
        probabilityButton.addEventListener('mouseleave', () => { if (isHolding) { handleInteractionEnd(); } });
        probabilityButton.addEventListener('touchstart', (event) => { event.preventDefault(); handleInteractionStart(); }, { passive: false }); 
        probabilityButton.addEventListener('touchend', handleInteractionEnd);

        questionInput.addEventListener('input', () => { 
            if (initialMessage.classList.contains('text-red-500')) { 
                initialMessage.textContent = "Ingresa una pregunta y mant√©n presionado el bot√≥n."; 
                initialMessage.classList.remove('text-red-500', 'font-semibold'); 
                initialMessage.classList.remove('hidden'); 
                calculatingText.classList.add('hidden'); 
                finalResult.classList.add('hidden'); 
                extendedAdviceButton.classList.add('hidden');
                extendedAdviceContainer.classList.add('hidden');
                suggestedLinkContainer.classList.add('hidden');
                suggestedLinkText.innerHTML = '';
                darkOmenContainer.classList.add('hidden');
                darkOmenText.textContent = '';
                wordGameContainer.classList.add('hidden'); // Tambi√©n ocultar juego de palabras
                hideAllDynamicIcons(); 
            }
            if (instructionText.textContent.includes("Sigue presionando") || instructionText.textContent.includes("El or√°culo ha hablado")) { 
                instructionText.textContent = "prep√°rate para saber si har√°s eso o no"; 
            }
        });
    </script>
</body>
</html>

